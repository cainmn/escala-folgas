  <!DOCTYPE html>
  <html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Grupo TEM | Controle</title>

    <!-- jsPDF + autoTable para PDF da escala -->
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

      <style>
        :root{
          --bg:#f3f6fb;
          --bg-alt:#e3ebf7;
          --card:#ffffff;
          --card-soft:#f7f9fc;
          --border:#cbd4e3;
          --text:#1f2933;
          --text-soft:#5a7184;
          --accent:#1967d2;
          --accent-soft:#e1ecff;
          --accent-strong:#144596;
          --danger:#e55353;
          --danger-soft:#ffe0e0;
          --ok:#2e8b57;
          --warn-soft:#fff6c2;
          --shadow:0 10px 30px rgba(15, 23, 42, 0.12);

          --btn-primary-bg:#1967d2;
          --btn-primary-text:#ffffff;
          --btn-secondary-bg:#e3ebf7;
          --btn-secondary-text:#1f2933;
          --btn-danger-bg:#e55353;
          --btn-danger-text:#ffffff;
          --btn-soft-bg:#f2f6ff;
          --btn-soft-text:#144596;

          --input-bg:#ffffff;
          --input-border:#cbd4e3;
          --input-text:#1f2933;

          --badge-warn-bg:#fff6c2;
          --badge-warn-border:#f0d24c;
          --badge-danger-bg:#ffd2d2;
          --badge-danger-border:#aa1f1f;

          --nav-bg:#0f172a;
          --nav-text:#e5e7eb;
          --nav-text-muted:#9ca3af;
          --nav-accent:#3b82f6;

          --font-base:15px;
        }

        .dark{
          --bg:#070b12;
          --bg-alt:#0f172a;
          --card:#111827;
          --card-soft:#0b1220;
          --border:#1f2937;
          --text:#e5e7eb;
          --text-soft:#9ca3af;
          --accent:#3b82f6;
          --accent-soft:#1d3a66;
          --accent-strong:#60a5fa;
          --danger:#f87171;
          --danger-soft:#4b1010;
          --ok:#34d399;
          --warn-soft:#4b4630;
          --shadow:0 10px 35px rgba(0,0,0,0.7);

          --btn-primary-bg:#2563eb;
          --btn-primary-text:#f9fafb;
          --btn-secondary-bg:#111827;
          --btn-secondary-text:#e5e7eb;
          --btn-danger-bg:#b91c1c;
          --btn-danger-text:#fee2e2;
          --btn-soft-bg:#1f2937;
          --btn-soft-text:#e5e7eb;

          --input-bg:#020617;
          --input-border:#374151;
          --input-text:#e5e7eb;

          --badge-warn-bg:#facc15;
          --badge-warn-border:#fbbf24;
          --badge-danger-bg:#b91c1c;
          --badge-danger-border:#fecaca;

          --nav-bg:#020617;
          --nav-text:#e5e7eb;
          --nav-text-muted:#6b7280;
          --nav-accent:#60a5fa;
        }

        *{ box-sizing:border-box; }

        body{
          margin:0;
          padding:0;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
          background:var(--bg);
          color:var(--text);
          font-size:var(--font-base);
        }

        a{ color:var(--accent); text-decoration:none; }

        /* Top Navbar */
        .topbar{
          position:sticky;
          top:0;
          z-index:100;
          background:var(--nav-bg);
          color:var(--nav-text);
          box-shadow:var(--shadow);
          padding:8px 14px;
          display:flex;
          align-items:center;
          gap:12px;
        }
        .topbar-brand{
          font-weight:700;
          letter-spacing:0.03em;
          display:flex;
          align-items:center;
          gap:8px;
          font-size:16px;
          
        }
        .topbar-brand span.logo-dot{
          width:10px;height:10px;border-radius:999px;
          background:var(--nav-accent);
        }
        .tab-nav{
          display:flex;
          gap:4px;
          margin:0 10px;
          flex:1;
          overflow-x:auto;
          scrollbar-width:auto;
        }
            /* Scrollbar da navbar */
        .tab-nav {
          overflow-x: auto;
          scrollbar-width: thin;
          scrollbar-color: var(--nav-accent) transparent;
        }

        .tab-nav::-webkit-scrollbar {
          height: 6px;
        }

        .tab-nav::-webkit-scrollbar-track {
          background: transparent;
        }

        .tab-nav::-webkit-scrollbar-thumb {
          background: var(--nav-accent);
          border-radius: 10px;
        }


        .tab-btn{
          border:none;
          border-radius:999px;
          padding:6px 14px;
          font-size:14px;
          background:transparent;
          color:var(--nav-text-muted);
          cursor:pointer;
          white-space:nowrap;
          display:inline-flex;
          align-items:center;
          gap:4px;
          transition: background .15s, color .15s, transform .1s;
        }
        .tab-btn span.icon{ font-size:15px; }
        .tab-btn.active{
          background:rgba(59,130,246,0.16);
          color:var(--nav-accent);
          transform:translateY(-1px);
        }
        .tab-btn:hover{
          background:rgba(148,163,184,0.25);
        }

        .topbar-right{
          display:flex;
          align-items:center;
          gap:10px;
          flex-shrink:0;
        }
        .chip{
          padding:4px 10px;
          border-radius:999px;
          border:1px solid rgba(148,163,184,0.5);
          font-size:12px;
          color:var(--nav-text-muted);
          display:flex;
          align-items:center;
          gap:6px;
          max-width:170px;
          white-space:nowrap;
          overflow:hidden;
          text-overflow:ellipsis;
        }
        .chip-dot{
          width:7px;height:7px;border-radius:999px;
          background:#22c55e;
          box-shadow:0 0 0 4px rgba(34,197,94,.2);
        }
        .btn-small{
          border-radius:999px;
          border:1px solid rgba(148,163,184,0.6);
          background:transparent;
          color:var(--nav-text);
          padding:5px 12px;
          font-size:13px;
          cursor:pointer;
          display:flex;
          align-items:center;
          gap:6px;
        }
        .btn-small.primary{
          border:none;
          background:var(--nav-accent);
          color:#f9fafb;
        }
        .switch{
          display:flex;
          align-items:center;
          gap:6px;
          font-size:12px;
          color:var(--nav-text-muted);
          cursor:pointer;
        }
        .switch input{ display:none; }
        .switch-pill{
          width:34px;
          height:18px;
          border-radius:999px;
          background:#111827;
          border:1px solid #475569;
          position:relative;
          transition:.15s;
        }
        .switch-thumb{
          position:absolute;
          top:1px;
          left:1px;
          width:14px;height:14px;
          border-radius:999px;
          background:#9ca3af;
          transition:.15s;
        }
        .switch input:checked + .switch-pill{
          background:#1d4ed8;
          border-color:#60a5fa;
        }
        .switch input:checked + .switch-pill .switch-thumb{
          transform:translateX(16px);
          background:#e5e7eb;
        }

        /* Layout */
        main{
          padding:16px;
          max-width:1200px;
          margin:0 auto 40px;
        }

        .page{
          display:none;
          animation:fadeIn .18s ease-out;
        }
        .page.active{ display:block; }

        @keyframes fadeIn{
          from{ opacity:0; transform:translateY(4px);}
          to{ opacity:1; transform:translateY(0);}
        }

        .page-header{
          margin-bottom:14px;
          display:flex;
          justify-content:space-between;
          align-items:flex-end;
          gap:10px;
          flex-wrap:wrap;
        }
        .page-header h2{
          margin:0;
          font-size:20px;
          display:flex;
          align-items:center;
          gap:8px;
        }
        .page-header p{
          margin:2px 0 0;
          font-size:13px;
          color:var(--text-soft);
        }

        .card{
          background:var(--card);
          border-radius:14px;
          box-shadow:var(--shadow);
          padding:14px 14px 16px;
          margin-bottom:14px;
          border:1px solid var(--border);
        }
        .card-header{
          display:flex;
          justify-content:space-between;
          align-items:center;
          gap:10px;
          margin-bottom:10px;
        }
        .card-header h3{
          margin:0;
          font-size:16px;
        }
        .card-sub{
          font-size:12px;
          color:var(--text-soft);
        }

        .grid-2{
          display:grid;
          grid-template-columns: minmax(0,1.3fr) minmax(0,1.2fr);
          gap:12px;
        }
        .grid-3{
          display:grid;
          grid-template-columns: repeat(3, minmax(0,1fr));
          gap:10px;
        }
        .grid-4{
          display:grid;
          grid-template-columns: repeat(4, minmax(0,1fr));
          gap:10px;
        }

        label{
          font-size:13px;
          color:var(--text-soft);
          margin-bottom:2px;
          display:block;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea{
          width:100%;
          padding:8px 9px;
          border-radius:9px;
          border:1px solid var(--input-border);
          background:var(--input-bg);
          color:var(--input-text);
          font-size:14px;
          outline:none;
          transition:.12s border, .12s box-shadow, .12s background;
        }
        textarea{
          min-height:80px;
          resize:vertical;
        }
        input:focus, select:focus, textarea:focus{
          border-color:var(--accent);
          box-shadow:0 0 0 1px rgba(37,99,235,0.4);
        }

        .btn{
          border-radius:999px;
          border:none;
          padding:7px 14px;
          font-size:14px;
          cursor:pointer;
          display:inline-flex;
          align-items:center;
          gap:6px;
          background:var(--btn-secondary-bg);
          color:var(--btn-secondary-text);
          transition:.12s transform, .12s box-shadow, .12s background, .12s color, .12s opacity;
          white-space:nowrap;
        }
        .btn-sm{
          padding:5px 10px;
          font-size:13px;
          border-radius:999px;
        }
        .btn-primary{
          background:var(--btn-primary-bg);
          color:var(--btn-primary-text);
          box-shadow:0 4px 14px rgba(37,99,235,0.4);
        }
        .btn-primary:hover{ transform:translateY(-1px); }
        .btn-soft{
          background:var(--btn-soft-bg);
          color:var(--btn-soft-text);
        }
        .btn-danger{
          background:var(--btn-danger-bg);
          color:var(--btn-danger-text);
        }
        .btn-ghost{
          background:transparent;
          border:1px solid var(--border);
        }
        .btn-icon{
          width:32px;height:32px;
          border-radius:999px;
          display:inline-flex;
          align-items:center;
          justify-content:center;
          padding:0;
        }
        .btn-disabled{
          opacity:0.5;
          cursor:not-allowed;
          box-shadow:none !important;
        }

        .stack-h{
          display:flex;
          gap:8px;
          flex-wrap:wrap;
          align-items:center;
        }

        .badge{
          display:inline-flex;
          align-items:center;
          gap:6px;
          font-size:11px;
          padding:3px 8px;
          border-radius:999px;
          background:var(--badge-warn-bg);
          border:1px solid var(--badge-warn-border);
          color:#111827;
        }

        .table-container{
          overflow-x:auto;
          border-radius:10px;
          border:1px solid var(--border);
          background:var(--card-soft);
        }
        table{
          width:100%;
          border-collapse:collapse;
          font-size:13px;
          min-width:700px;
        }
        thead{
          background:var(--accent-soft);
        }
        th,td{
          padding:6px 8px;
          text-align:left;
          border-bottom:1px solid var(--border);
          white-space:nowrap;
        }
        th{
          font-weight:600;
          font-size:12px;
          color:var(--text-soft);
        }
        tbody tr:nth-child(even){
          background:rgba(148,163,184,0.05);
        }

        .pessoa{
          background:var(--card);
          border-radius:12px;
          border:1px solid var(--border);
          padding:10px 10px 8px;
          margin-bottom:10px;
        }
        .pessoa-header{
          display:flex;
          justify-content:space-between;
          align-items:center;
          gap:8px;
          margin-bottom:6px;
        }
        .pessoa-nome{
          font-size:15px;
          font-weight:600;
          display:flex;
          align-items:center;
          gap:6px;
        }

        .folga-item{
          padding:5px 0;
          border-top:1px dashed rgba(148,163,184,0.4);
          margin-top:4px;
        }
        .folga-item:first-of-type{
          border-top:none;
          margin-top:0;
        }
        .folga-data{
          font-weight:600;
          font-size:13px;
        }
        .folga-hora{
          font-size:12px;
          color:var(--text-soft);
        }

        .em-folga{
          background:var(--badge-danger-bg) !important;
          border-left:6px solid var(--badge-danger-border);
          color:#111827 !important;
        }
        .em-folga *{ color:#111827 !important; }

        .entra-hoje{
          background:var(--badge-warn-bg) !important;
          border-left:6px solid var(--badge-warn-border);
          color:#111827 !important;
        }
        .entra-hoje *{ color:#111827 !important; }

        .modal-backdrop{
          position: fixed;
          inset: 0;
          background: rgba(15,23,42,0.55);
          display: none;
          align-items: center;
          justify-content: center;
          z-index: 99999;
        }

        .modal-backdrop.active{
          display: flex;
        }

        .modal{
          background:var(--card);
          border-radius:16px;
          padding:16px 18px 14px;
          box-shadow:var(--shadow);
          max-width:380px;
          width:100%;
          border:1px solid var(--border);
        }
        .modal h3{
          margin:0 0 6px;
          font-size:17px;
        }
        .modal-footer{
          margin-top:12px;
          display:flex;
          justify-content:flex-end;
          gap:8px;
        }
        .modal-small-text{
          font-size:12px;
          color:var(--text-soft);
        }

        .pill{
          border-radius:999px;
          padding:2px 8px;
          font-size:11px;
          background:var(--accent-soft);
          color:var(--accent-strong);
        }

        .notice{
          font-size:12px;
          color:var(--text-soft);
          background:var(--card-soft);
          border-radius:10px;
          padding:7px 9px;
          border:1px dashed var(--border);
        }

        .section-title{
          font-size:14px;
          font-weight:600;
          margin-bottom:6px;
          display:flex;
          gap:6px;
          align-items:center;
        }

        @media(max-width:900px){
          main{ padding:10px; }
          .grid-2{ grid-template-columns:minmax(0,1fr); }
          .grid-3{ grid-template-columns:minmax(0,1fr); }
          .grid-4{ grid-template-columns:repeat(2,minmax(0,1fr)); }
          .page-header{
            flex-direction:column;
            align-items:flex-start;
          }
        }

        @media(max-width:640px){
          .topbar{
            flex-wrap:wrap;
            row-gap:6px;
          }
          .tab-nav{
            order:3;
            width:100%;
          }
          .topbar-right{
            margin-left:auto;
          }
          .table-container{ border-radius:8px; }
          table{ font-size:12px; min-width:600px; }
          .btn, .btn-sm{
            font-size:13px;
          }
          input,select,textarea{
            font-size:14px;
          }
        }

    

        /* === LOGIN ESTILO SUPABASE / GOOGLE === */

  #loginBackdrop {
    backdrop-filter: blur(8px);
    background: rgba(0,0,0,0.35);
  }

  /* Container do modal */
  #loginBackdrop .modal {
    padding: 32px 28px;
    border-radius: 22px;
    width: 100%;
    max-width: 380px;
    animation: zoomFade 0.25s ease-out;
    box-shadow: 0 8px 28px rgba(0,0,0,0.18);
    border: 1px solid var(--border);
    position: relative;
  }

  /* √çcone superior */
  #loginBackdrop .modal::before {
    content: "üîê";
    font-size: 42px;
    display: block;
    text-align: center;
    margin-bottom: 12px;
  }

  /* T√≠tulo */
  #loginBackdrop h3 {
    font-size: 22px;
    font-weight: 700;
    margin-bottom: 6px;
    text-align: center;
  }

  /* Subt√≠tulo */
  #loginBackdrop .modal-small-text {
    font-size: 14px;
    color: var(--text-soft);
    margin-bottom: 20px;
    text-align: center;
  }

  /* === CAMPOS DE INPUT COM √çCONE === */

  .login-field {
    position: relative;
    margin-bottom: 16px;
  }

  .login-field input {
    width: 100%;
    padding: 12px 12px 12px 40px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: var(--input-bg);
    font-size: 14px;
    transition: border-color .15s, box-shadow .15s;
  }

  .login-field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 2px rgba(25,103,210,0.25);
  }

  /* √çcone dentro do input */
  .login-field .icon {
    position: absolute;
    top: 50%;
    left: 12px;
    transform: translateY(-50%);
    font-size: 18px;
    opacity: 0.8;
  }

  /* Checkbox */
  #loginBackdrop label input[type="checkbox"] {
    accent-color: var(--accent);
  }

  /* Rodap√© */
  #loginBackdrop .modal-footer {
    margin-top: 25px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
  }

  /* Bot√£o principal estilo Google */
  #loginBackdrop .btn-primary {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    background: var(--accent);
    transition: background 0.15s;
  }

  #loginBackdrop .btn-primary:hover {
    background: var(--accent-dark);
  }

  #loginMsg {
    margin-top: 8px;
    text-align: center;
    font-size: 13px;
    color: var(--danger);
  }

  /* === Anima√ß√£o === */
  @keyframes zoomFade {
    from { opacity: 0; transform: scale(0.92); }
    to { opacity: 1; transform: scale(1); }
  }

  /*overlay cinza */

  .modal-overlay-lock {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(3px);
    color: white;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    border-radius: 12px;
    z-index: 20;
    opacity: 0;
    pointer-events: none;
    transition: 0.2s ease;
  }

  .modal-locked .modal-overlay-lock {
    opacity: 1;
    pointer-events: all;
  }

  .modal-locked input,
  .modal-locked select,
  .modal-locked button {
    pointer-events: none !important;
    opacity: 0.4;
  }




  /* mobile */
  @media(max-width:900px){
    .hamburger-btn{
      display:flex;
    }


    .topbar{
      position:sticky;
      top:0;
      z-index:130;
    }

    .tab-nav{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:var(--nav-bg);
      padding:8px 10px 10px;
      flex-direction:column;
      gap:6px;
      border-bottom:1px solid rgba(148,163,184,0.5);
      box-shadow:0 14px 30px rgba(15,23,42,0.8);
      display:none;           /* escondido por padr√£o */
    }

    .topbar.nav-open .tab-nav{
      display:flex;           /* mostra quando clicar no hamb√∫rguer */
    }

    .tab-btn{
      justify-content:flex-start;
      border-radius:10px;
      width:100%;
    }

    .tab-btn.active{
      transform:none;         /* sem levantar no mobile */
    }

    .topbar{
      gap:8px;
    }
  }



  @media(max-width: 900px){
    .tab-nav {
      flex: unset !important;
    }
  }

  /* === BOT√ÉO FLUTUANTE COM SETA === */

  .hamburger-btn {
    position: fixed;
    top: 6px;
    left: 400px;
    z-index: 9999;

    width: 32px !important;
    height: 32px !important;

    border: none;
    border-radius: 6px;

    background: rgba(255,255,255,0.18);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);

    display: none; /* s√≥ aparece no mobile */
    align-items: center;
    justify-content: center;

    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.35);
    transition: 0.2s;
  }

  .hamburger-btn:hover {
    background: rgba(255,255,255,0.28);
    transform: scale(1.05);
  }

  /* dark mode */
  .dark .hamburger-btn {
    background: rgba(255,255,255,0.08);
  }
  .dark .hamburger-btn:hover {
    background: rgba(255,255,255,0.15);
  }

  /* Desenho da seta */
  .hamburger-btn::before {
    content: "";
    width: 8px;
    height: 8px;

    border-right: 2px solid white;
    border-bottom: 2px solid white;

    transform: rotate(45deg); /* seta ‚Üí */
    transition: 0.25s ease;
  }

  /* seta ‚Üì quando abre */
  .topbar.nav-open ~ .hamburger-btn::before {
    transform: rotate(135deg);
  }

  /* Mostrar apenas no mobile */
  @media (max-width: 900px) {
    .hamburger-btn {
      display: flex !important;
    }
  }

.modal-backdrop{
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease;
}

.modal-backdrop.active{
  display: flex;
  opacity: 1;
  pointer-events: auto;
}


.badge-lock{
  display:inline-block;
  padding:4px 8px;
  font-size:11px;
  border-radius:999px;
  background:#f1f5f9;
  color:#475569;
  font-weight:600;
}

.mobile-nav-backdrop{
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 40;
}

.topbar.nav-open + .mobile-nav-backdrop,
.mobile-nav-backdrop.active{
  display: block;
}


/* ===== LOGIN MODAL PADR√ÉO ===== */
#loginBackdrop{
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;

  background: rgba(0,0,0,0.6);
  z-index: 9999;

  opacity: 0;
  pointer-events: none;
}

#loginBackdrop.active{
  opacity: 1;
  pointer-events: auto;
}

#loginBackdrop .modal{
  transform: translateY(30px);
  opacity: 0;
  transition: all .25s ease;
}

#loginBackdrop.active .modal{
  transform: translateY(0);
  opacity: 1;
}




      </style>
  </head>

  
  <body>
<button class="hamburger-btn" id="hamburgerBtn" aria-label="Abrir menu"></button> 
    <!-- LOGIN MODAL -->
    <div class="modal-backdrop" id="loginBackdrop">
      <div class="modal">
        <h3>Entrar no sistema</h3>
        <p class="modal-small-text">Use o usu√°rio criado no Supabase (email e senha).</p>
      <!-- Campo de Email -->
        <div class="login-field">
          <span class="icon">üìß</span>
          <input type="email" id="loginEmail" placeholder="Seu email">
        </div>
          <div class="login-field">
          <span class="icon">üîë</span>
          <input type="password" id="loginPass" placeholder="Sua senha">
        </div>
          <label style="margin-top:4px; display:flex; align-items:center; gap:6px; font-size:12px;">
          <input type="checkbox" id="rememberMe" style="width:auto; padding:0;">
          Lembrar de mim neste dispositivo
        </label>
        <div id="loginMsg" class="modal-small-text" style="margin-top:6px;color:crimson;"></div>
        <div class="modal-footer">
          <button class="btn btn-ghost btn-sm" onclick="closeLoginModal()">Cancelar</button>
          <button class="btn btn-primary btn-sm" onclick="doLogin()">Entrar</button>
        </div>
      </div>
    </div>

    <!-- GERENCIAR MOTORISTAS/PLACAS MODAL -->
    <div class="modal-backdrop" id="mpBackdrop">
      <div class="modal" style="max-width:600px;">
        <h3>Gerenciar Motoristas & Placas</h3>
        <p class="modal-small-text">Itens inativos deixam de aparecer nos formul√°rios, mas permanecem no hist√≥rico.</p>

        <div class="grid-2" style="margin-top:8px;">
          <div>
            <div class="section-title">Motoristas</div>
            <div class="notice" style="margin-bottom:6px;">Clique em <b>Inativar</b> para esconder da lista.</div>
            <div id="listaMotoristas" style="max-height:180px;overflow-y:auto;font-size:13px;border:1px solid var(--border);border-radius:8px;padding:4px;"></div>
            <div style="display:flex; gap:6px; margin-top:6px;">
              <input type="text" id="novoMotorista" placeholder="Novo motorista">
              <button class="btn btn-soft btn-sm" onclick="adicionarMotorista()">Adicionar</button>
            </div>
          </div>
          <div>
            <div class="section-title">Placas</div>
            <div class="notice" style="margin-bottom:6px;">Use sempre o padr√£o ABC-1234 / ABC1D23.</div>
            <div id="listaPlacas" style="max-height:180px;overflow-y:auto;font-size:13px;border:1px solid var(--border);border-radius:8px;padding:4px;"></div>
            <div style="display:flex; gap:6px; margin-top:6px;">
              <input type="text" id="novaPlaca" placeholder="Nova placa">
              <button class="btn btn-soft btn-sm" onclick="adicionarPlaca()">Adicionar</button>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-primary btn-sm" onclick="refreshMotoristasPlacas()">Atualizar do banco</button>
          <button class="btn btn-ghost btn-sm" onclick="closeMpModal()">Fechar</button>
        </div>
      </div>
    </div>

        <!-- TOPO -->
    <header class="topbar">
      <div class="topbar-brand">
        <span>üööGrupo TEM - Painel</span>
      </div>

      <!-- BOT√ÉO HAMB√öRGUER (MOBILE) -->
      
     
      <nav class="tab-nav">
        <button class="tab-btn active" data-target="page-escala">
          <span class="icon">üìÖ</span> Escala
        </button>
        <button class="tab-btn" data-target="page-abastecimento">
          <span class="icon">‚õΩ</span> Abastecimento
        </button>
        <button class="tab-btn" data-target="page-calculadora">
          <span class="icon">üßÆ</span> Calculadora
        </button>
        <button class="tab-btn" data-target="page-servicos" id="tabServicos">
          <span class="icon">üöö</span> Servi√ßos Particulares
        </button>

        <button class="tab-btn" data-target="page-tabela">
          <span class="icon">üìã</span> Tabela
        </button>
        <button class="tab-btn" data-target="page-comissao" id="tabComissao" style="display:none;">
          <span class="icon">üíº</span> Comiss√£o
        </button>
      </nav>

      <div class="topbar-right">
        <div class="chip" id="userChip">
          <span class="chip-dot" id="userStatusDot" style="background:#ef4444; box-shadow:0 0 0 4px rgba(239,68,68,.25);"></span>
          <span id="userChipText">N√£o conectado</span>
        </div>
        <button class="btn-small primary" id="btnLoginTop" onclick="openLoginModal()">
          Entrar
        </button>
        <button class="btn-small" id="btnLogoutTop" style="display:none;" onclick="logout()">
          Sair
        </button>
        <label class="switch">
          <input type="checkbox" id="darkToggle">
          <span class="switch-pill"><span class="switch-thumb"></span></span>
          <span>Modo escuro</span>
        </label>
      </div>
    </header>

    <!-- BACKDROP DO MENU MOBILE -->
    <div class="mobile-nav-backdrop" id="mobileNavBackdrop"></div>

<!-- SERVI√áOS PARTICULARES -->
<section id="page-servicos" class="page">
  <div class="page-header">
    <div>
      <h2>Servi√ßos Particulares</h2>
      <p>Visualize, filtre, edite e exclua servi√ßos particulares.</p>
    </div>
    <div class="stack-h">
      <button class="btn btn-soft btn-sm" onclick="loadServicos()">Atualizar do banco</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <div>
        <h3>Filtros</h3>
        <div class="card-sub">Filtre por data, motorista, placa e placa do cliente.</div>
      </div>
    </div>

    <div class="grid-4" style="margin-bottom:10px;">
      <div>
        <label>Data inicial</label>
        <input type="date" id="servFiltroDataIni">
      </div>
      <div>
        <label>Data final</label>
        <input type="date" id="servFiltroDataFim">
      </div>
      <div>
        <label>Placa empresa</label>
        <select id="servFiltroPlacaEmp">
          <option value="">Todas</option>
        </select>
      </div>
      <div>
        <label>Placa cliente</label>
        <input type="text" id="servFiltroPlacaCli" placeholder="Opcional">
      </div>
    </div>

    <div class="grid-3" style="margin-bottom:10px;">
      <div>
        <label>Motorista</label>
        <select id="servFiltroMotorista">
          <option value="">Todos</option>
        </select>
      </div>
    </div>

    <div class="stack-h" style="margin-bottom:8px;">
      <button class="btn btn-soft btn-sm" onclick="aplicarFiltroServicos()">Aplicar filtro</button>
      <button class="btn btn-ghost btn-sm" onclick="limparFiltroServicos()">Limpar filtro</button>
      <button class="btn btn-soft btn-sm" onclick="gerarPDFServicos()">Gerar PDF</button>
    </div>

    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Origem</th>
            <th>Destino</th>
            <th>Motorista</th>
            <th>Placa (empresa)</th>
            <th>Placa cliente</th>
            <th>Status</th>
            <th>Total (R$)</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="servicosTabelaBody"></tbody>
      </table>
    </div>
  </div>
</section>

    <main>

      <!-- ESCALA -->
      <section id="page-escala" class="page active">
        <div class="page-header">
          <div>
            <h2>Escala de Folgas</h2>
            <p>Visualize, edite e exporte a escala de folgas da equipe.</p>
          </div>
          <div class="stack-h">
            <button class="btn btn-soft btn-sm" onclick="mostrarFolgasAgora()">Quem est√° de folga agora?</button>
            <button class="btn btn-soft btn-sm" onclick="scheduleLocalReminders()">Agendar notifica√ß√µes (local)</button>
            <button class="btn btn-primary btn-sm" data-auth="protected" onclick="gerarPDFFuncionarioMes()">PDF Funcion√°rio / M√™s</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h3>Filtros</h3>
              <div class="card-sub">Use os filtros para focar em um funcion√°rio ou m√™s espec√≠fico.</div>
            </div>
            <button class="btn btn-soft btn-sm" onclick="carregarFolgasDoBanco()">Atualizar do banco</button>
          </div>
          <div class="stack-h" style="margin-bottom:8px;">
            <div style="min-width:200px;flex:1;">
              <label for="escalaFuncSelect">Funcion√°rio</label>
              <select id="escalaFuncSelect"></select>
            </div>

            <div style="min-width:190px;flex:1;">
              <label for="escalaMesSelect">M√™s / Ano</label>
              <select id="escalaMesSelect"></select>
            </div>
          </div>
          <div class="notice">
            <b>Permiss√µes:</b> apenas usu√°rios logados podem editar, adicionar ou remover folgas, e salvar altera√ß√µes no banco.
          </div>
        </div>

        <div id="listaEscala"></div>
      </section>

      <!-- ABASTECIMENTO -->
      <section id="page-abastecimento" class="page">
        <div class="page-header">
          <div>
            <h2>Abastecimentos</h2>
            <p>Registre abastecimentos, edite lan√ßamentos e gere relat√≥rios.</p>
          </div>
          <div class="stack-h">
            
            <button class="btn btn-soft btn-sm" onclick="loadAbastecimentos()">Atualizar do banco</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h3>Registro de Abastecimento</h3>
              <div class="card-sub">Preencha os dados e clique em salvar. Somente usu√°rios logados podem registrar.</div>
            </div>
            <span class="pill" id="abastModeLabel">Modo: novo lan√ßamento</span>
          </div>

          <div class="grid-3" style="margin-bottom:8px;">
            <div>
              <label>Data</label>
              <input type="date" id="abastData">
            </div>
            <div>
              <label>Placa</label>
              <select id="abastPlaca" onchange="autoKmAnterior()"></select>
            </div>
            <div>
              <label>Motorista</label>
              <select id="abastMotorista"></select>
            </div>
          </div>

          <div class="grid-4" style="margin-bottom:8px;">
            <div>
              <label>Combust√≠vel</label>
              <select id="abastCombustivel">
                <option value="Diesel">Diesel</option>
                <option value="Gasolina">Gasolina</option>
                <option value="Etanol">Etanol</option>
                <option value="Arla 32">Arla 32</option>
              </select>
            </div>
            <div>
              <label>Km Anterior</label>
              <input type="number" id="abastKmAnt" step="1">
            </div>
            <div>
              <label>Km Atual</label>
              <input type="number" id="abastKmAtual" step="1">
            </div>
            <div>
              <label>Litros</label>
              <input type="number" id="abastLitros" step="0.01">
            </div>
          </div>

          <div class="grid-3" style="margin-bottom:8px;">
            <div>
              <label>Valor por litro (R$)</label>
              <input type="number" id="abastValorLitro" step="0.01">
            </div>
            <div>
              <label>Total (R$)</label>
              <input type="text" id="abastTotal" readonly>
            </div>
            <div>
              <label>M√©dia (km/l)</label>
              <input type="text" id="abastMedia" readonly>
            </div>
          </div>

          <div class="stack-h" style="justify-content:flex-end;margin-top:6px;">
            <button class="btn btn-ghost btn-sm" onclick="limparFormularioAbast()">Limpar</button>
            <button class="btn btn-primary btn-sm" data-auth="protected" onclick="salvarAbastecimento()">Salvar abastecimento</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h3>Relat√≥rio de abastecimentos</h3>
              <div class="card-sub">Filtros locais com base nos registros carregados do Supabase.</div>
            </div>
          </div>

          <div class="grid-4" style="margin-bottom:10px;">
            <div>
              <label>Data inicial</label>
              <input type="date" id="abastFiltroDataIni">
            </div>
            <div>
              <label>Data final</label>
              <input type="date" id="abastFiltroDataFim">
            </div>
            <div>
              <label>Placa</label>
              <select id="abastFiltroPlaca">
                <option value="">Todas</option>
              </select>
            </div>  
            <div>
              <label>Motorista</label>
              <select id="abastFiltroMotorista">
                <option value="">Todos</option>
              </select>
            </div>
          </div>

          <div class="stack-h" style="margin-bottom:8px;">
            <button class="btn btn-soft btn-sm" onclick="aplicarFiltroAbastecimento()">Aplicar filtro</button>
            <button class="btn btn-ghost btn-sm" onclick="limparFiltroAbastecimento()">Limpar filtro</button>
          </div>

          <div class="stack-h" style="margin-bottom:8px;">
            <button class="btn btn-primary btn-sm" onclick="gerarRelatorioAbastecimento()">Gerar relat√≥rio (PDF)</button>
          </div>


          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Placa</th>
                  <th>Motorista</th>
                  <th>Comb.</th>
                  <th>Km Ant</th>
                  <th>Km Atual</th>
                  <th>Litros</th>
                  <th>R$/L</th>
                  <th>Total</th>
                  <th>M√©dia</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="abastecimentoTabelaBody">
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CALCULADORA -->
      <section id="page-calculadora" class="page">
        <div class="page-header">
          <div>
            <h2>Calculadora de Servi√ßo</h2>
            <p>Simule valores de servi√ßos (cobran√ßa, custos e lucro).</p>
          </div>
        </div>

        <div class="card">
          <div class="grid-2">
            <div>
              <div class="section-title">Dados da rota</div>
              <label>Origem</label>
              <input type="text" id="calcOrigem" placeholder="Ex: Campinas - SP">
              <label>Destino</label>
              <input type="text" id="calcDestino" placeholder="Ex: S√£o Paulo - SP">

              <label style="margin-top:6px;">KM total</label>
              <input type="number" id="calcKmTotal" step="0.1" value="0">

              <label style="margin-top:6px;">Categoria (preenche valores)</label>
              <select id="calcCategoria"></select>

              <label>Valor por KM (R$)</label>
              <input type="number" id="calcValorKm" step="0.01" value="0.00">

              <label>Valor de sa√≠da (R$)</label>
              <input type="number" id="calcValorSaida" step="0.01" value="0.00">

              <label style="margin-top:6px;">M√©dia (km/L) ‚Äî inserir manualmente</label>
              <input type="number" id="calcMediaKmL" step="0.01">

              <label style="margin-top:6px;">Pre√ßo combust√≠vel (R$/L)</label>
              <input type="number" id="calcPrecoComb" step="0.01" value="0.00">

              <label style="margin-top:6px;">Ped√°gios (R$)</label>
              <input type="number" id="calcPedagios" step="0.01" value="0.00">

              <div style="margin-top:10px;">
                <button class="btn btn-primary btn-sm" onclick="calcularServico()">Calcular</button>
              </div>
            </div>

            <div>
              <div class="section-title">Resultados</div>
              <textarea id="calcResultado" readonly style="height:260px;"></textarea>

              <div class="section-title" style="margin-top:10px;">Servi√ßo Particular (resumo)</div>
              <div class="grid-2">
                <div>
                  <label>Valor total (R$)</label>
                  <input type="number" id="calcServValorTotal" step="0.01" value="0.00">
                </div>
                <div>
                  <label>Status</label>
                  <select id="calcServStatus">
                    <option>N√£o pago</option>
                    <option>Pago</option>
                    <option>Pendente</option>
                  </select>
                </div>
              </div>

              <div class="grid-2" style="margin-top:6px;">
                <div>
                  <label>M√©todo pagamento</label>
                  <select id="calcServMetodo">
                    <option>Dinheiro</option>
                    <option>Pix</option>
                    <option>Cart√£o</option>
                    <option>Faturamento</option>
                  </select>
                </div>
                <div>
                  <label>Motorista</label>
                  <select id="calcServMotorista"></select>
                </div>
              </div>

              <div class="grid-2" style="margin-top:6px;">
                <div>
                  <label>Placa (empresa)</label>
                  <select id="calcServPlacaEmp"></select>
                </div>
                <div>
                  <label>Placa do cliente</label>
                  <input type="text" id="calcServPlacaCli" placeholder="Opcional">
                </div>
              </div>

              <label style="margin-top:6px;">Data do servi√ßo</label>
              <input type="date" id="calcServData">
            </div>
          </div>
        </div>

                <div style="margin-top:12px; text-align:right;">
          <button class="btn btn-primary btn-sm" onclick="salvarServicoParticular()">
            Salvar servi√ßo particular
          </button>
        </div>

      </section>

      <!-- TABELA (Categorias) -->
      <section id="page-tabela" class="page">
        <div class="page-header">
          <div>
            <h2>Tabela de Categorias</h2>
            <p>Gerencie a base de categorias e valores usados na calculadora.</p>
          </div>
          <div class="stack-h">
            <button class="btn btn-soft btn-sm" onclick="carregarCategorias()">Atualizar do banco</button>
            <button class="btn btn-soft btn-sm" onclick="openMpModal()" id="btnGerenciarMP">Gerenciar Motoristas / Placas</button>
            <button class="btn btn-primary btn-sm" data-auth="protected" onclick="adicionarCategoriaLocal()">Adicionar categoria</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h3>Categorias</h3>
              <div class="card-sub">Os valores abaixo s√£o usados para preencher a calculadora automaticamente.</div>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Categoria</th>
                  <th>Valor sa√≠da (R$)</th>
                  <th>Valor por km (R$)</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="tabelaCategoriasBody">
              </tbody>
            </table>
          </div>

          <div class="stack-h" style="justify-content:flex-end;margin-top:10px;">
            <button class="btn btn-primary btn-sm" data-auth="protected" onclick="salvarCategoriasNoBanco()">Salvar altera√ß√µes</button>
          </div>
        </div>
      </section>

      <!-- COMISS√ÉO -->
      <section id="page-comissao" class="page">
        <div class="page-header">
          <div>
            <h2>Comiss√£o</h2>
            <p>Registre servi√ßos para c√°lculo de comiss√µes e gere relat√≥rios.</p>
          </div>
          <div class="stack-h">
            <button class="btn btn-soft btn-sm" onclick="carregarComissoes()">Atualizar do banco</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h3>Registro de Comiss√£o</h3>
              
            </div>
            <span class="pill" id="comissaoModoLabel">Modo: novo lan√ßamento</span>
          </div>

          <div class="grid-3" style="margin-bottom:8px;">
            <div>
              <label>Data</label>
              <input type="date" id="comData">
            </div>
            <div>
              <label>Funcion√°rio</label>
              <select id="comFuncionario"></select>
            </div>
            <div>
              <label>Categoria</label>
              <select id="comCategoria"></select>
            </div>
          </div>

          <div class="grid-3" style="margin-bottom:8px;">
            <div>
              <label>KM total</label>
              <input type="number" id="comKmTotal" step="0.1">
            </div>
            <div>
              <label>Placa</label>
              <select id="comPlaca"></select>
            </div>
            <div>
              <label>Valor calculado (R$)</label>
              <input type="text" id="comValorCalc" readonly>
            </div>
          </div>

          <div class="grid-3" style="margin-bottom:8px;">
            <div>
              <label>Origem</label>
              <input type="text" id="comOrigem" placeholder="Cidade / regi√£o">
            </div>
            <div>
              <label>Destino</label>
              <input type="text" id="comDestino" placeholder="Cidade / regi√£o">
            </div>
            <div>
              <label>Seguradora</label>
              <select id="comSeguradora"></select>
            </div>
          </div>

          <div class="grid-3" style="margin-bottom:8px;">
            <div>
              <label>Empresa</label>
              <select id="comEmpresa"></select>
            </div>
            
            
          </div>

          <div class="stack-h" style="justify-content:flex-end;margin-top:4px;">
            <button class="btn btn-ghost btn-sm" onclick="limparFormularioComissao()">Limpar</button>
            <button class="btn btn-primary btn-sm" data-auth="protected" onclick="salvarComissao()">Salvar comiss√£o</button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <h3>Relat√≥rio de Comiss√µes</h3>
              <div class="card-sub">Veja todos os lan√ßamentos e filtre por data, placa, funcion√°rio e origem.</div>
            </div>
          </div>

          <div class="grid-4" style="margin-bottom:10px;">
            <div>
              <label>Data inicial</label>
              <input type="date" id="comFiltroDataIni">
            </div>
            <div>
              <label>Data final</label>
              <input type="date" id="comFiltroDataFim">
            </div>
            <div>
              <label>Funcion√°rio</label>
              <select id="comFiltroFunc">
                <option value="">Todos</option>
              </select>
            </div>
            <div>
              <label>Placa</label>
              <select id="comFiltroPlaca">
                <option value="">Todas</option>
              </select>
            </div>
          </div>

          <div class="grid-3" style="margin-bottom:8px;">
            <div>
              <label>Origem cont√©m (texto)</label>
              <input type="text" id="comFiltroOrigem" placeholder="Opcional">
            </div>
            <div>
              <label>Seguradora</label>
              <select id="comFiltroSeg">
                <option value="">Todas</option>
              </select>
            </div>
            <div>
              <label>Empresa</label>
              <select id="comFiltroEmp">
                <option value="">Todas</option>
              </select>
            </div>
          </div>

          <div class="stack-h" style="margin-bottom:8px;">
            <button class="btn btn-soft btn-sm" onclick="aplicarFiltroComissao()">Aplicar filtro</button>
            <button class="btn btn-ghost btn-sm" onclick="limparFiltroComissao()">Limpar filtro</button>
            <button class="btn btn-primary btn-sm" onclick="gerarPDFComissoes()">Gerar PDF</button>
          </div>


          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Data</th>
                  <th>Funcion√°rio</th>
                  <th>Categoria</th>
                  <th>KM</th>
                  <th>Placa</th>
                  <th>Origem</th>
                  <th>Destino</th>
                  <th>Seguradora</th>
                  <th>Empresa</th>
                  <th>Valor (R$)</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody id="comissaoTabelaBody"></tbody>
            </table>
          </div>
        </div>
      </section>

    </main>

    <!-- MODAL EDITAR SERVI√áO PARTICULAR -->
<div class="modal-backdrop" id="modalEditarServicoBackdrop">
  <div class="modal" id="modalEditarServico" data-auth="protected">
    <h3>Editar Servi√ßo Particular</h3>

    <div class="grid-2">
      <div>
        <label>Origem</label>
        <input type="text" id="editServOrigem">
      </div>
      <div>
        <label>Destino</label>
        <input type="text" id="editServDestino">
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Motorista</label>
        <select id="editServMotorista"></select>
      </div>
      <div>
        <label>Status</label>
        <select id="editServStatus">
          <option>Pago</option>
          <option>N√£o pago</option>
        </select>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Placa empresa</label>
        <select id="editServPlacaEmp"></select>
      </div>
      <div>
        <label>Placa cliente</label>
        <input type="text" id="editServPlacaCli">
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Valor total (R$)</label>
        <input type="number" step="0.01" id="editServValor">
      </div>
      <div>
        <label>Data</label>
        <input type="date" id="editServData">
      </div>
    </div>

    <div class="stack-h" style="margin-top:15px;">
      <button class="btn btn-primary" onclick="salvarEdicaoServico()">Salvar</button>
      <button class="btn btn-ghost" onclick="fecharModalEditarServico()">Cancelar</button>
    </div>
  </div>
</div>

<!-- MODAL EDITAR COMISS√ÉO -->
<div class="modal-backdrop" id="modalEditarComissaoBackdrop">
  <div class="modal" id="modalEditarComissao" data-auth="protected">
    <h3>Editar Comiss√£o</h3>

    <div class="grid-2">
      <div>
        <label>Data</label>
        <input type="date" id="editComData">
      </div>
      <div>
        <label>Funcion√°rio</label>
        <select id="editComFuncionario"></select>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Categoria</label>
        <select id="editComCategoria"></select>
      </div>
      <div>
        <label>KM Total</label>
        <input type="number" id="editComKmTotal" step="0.1">
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Placa</label>
        <select id="editComPlaca"></select>
      </div>
      <div>
        <label>Valor (R$)</label>
        <input type="text" id="editComValor" readonly>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Origem</label>
        <input type="text" id="editComOrigem">
      </div>
      <div>
        <label>Destino</label>
        <input type="text" id="editComDestino">
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Seguradora</label>
        <select id="editComSeguradora"></select>
      </div>
      <div>
        <label>Empresa</label>
        <select id="editComEmpresa"></select>
      </div>
    </div>

    <div class="stack-h" style="margin-top:15px;">
      <button class="btn btn-primary" onclick="salvarEdicaoComissao()">Salvar</button>
      <button class="btn btn-ghost" onclick="fecharModalEditarComissao()">Cancelar</button>
    </div>
  </div>
</div>



    <script>
      // ================== SUPABASE CONFIG ==================
  const SUPABASE_URL = "https://gaqazvekgpvecuhfuiel.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhcWF6dmVrZ3B2ZWN1aGZ1aWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MDc1NDQsImV4cCI6MjA4MDQ4MzU0NH0.crmOSloZVI0CMuJkIBLfOI6yKiT8dmEa10xrQnFBIcM";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // ========== LISTAS FIXAS (Calculadora / Comiss√£o) ==========
      const PLACAS_FIXAS = [
        "EGK-1831","DTA-9161","FFW-6G55","EVO-2E20","FQI-8816","FXM-2688",
        "CNR-2909","CVN-2760","KWP-5A14","GDI-6C39",
        "CYS-9F15","PJD-4E60","QBW-9697"
      ];
      
      const SEGURADORAS_FIXAS = ["TOKIO","USS","F√ÅCIL","MOVIDA","MONDIAL","EUROP","VX","PARTICULAR","LEIL√ÉO"];
      const EMPRESAS_FIXAS = ["ESTRELA","MARANI","TERUO","FORTI"];

      const CATEGORIAS_FIXAS = [
        {"categoria":"T√°xi","valor_km":1.70,"valor_saida":0.00},
        {"categoria":"Leve","valor_km":2.40,"valor_saida":140.00},
        {"categoria":"Utilit√°rio","valor_km":2.40,"valor_saida":200.00},
        {"categoria":"Pesado","valor_km":4.00,"valor_saida":400.00},
        {"categoria":"Extra Pesado","valor_km":5.80,"valor_saida":580.00},
        {"categoria":"Leil√£o","valor_km":120.00,"valor_saida":0.00},
        
      ];

      // ========== ESTADO GLOBAL ==========
      let currentUser = null;

      // Escala
      const folgas = [
        { nome:"Anderson Saraiva Serrano", editando:false, periodos:[
          ["2025-12-02 07:00","2025-12-03 19:00"],
          ["2025-12-10 19:00","2025-12-12 07:00"],
          ["2025-12-19 07:00","2025-12-20 19:00"],
          ["2025-12-27 19:00","2025-12-29 07:00"],
          ["2025-12-30 07:00","2025-12-31 19:00"]
        ]},
        { nome:"Henrique", editando:false, periodos:[
          ["2025-12-03 19:00","2025-12-05 07:00"],
          ["2025-12-12 07:00","2025-12-13 19:00"],
          ["2025-12-20 19:00","2025-12-22 07:00"],
          ["2025-12-23 07:00","2025-12-24 19:00"],
          ["2025-12-31 19:00","2026-01-02 07:00"]
        ]},
        { nome:"Jo√£o", editando:false, periodos:[
          ["2025-12-05 07:00","2025-12-06 19:00"],
          ["2025-12-13 19:00","2025-12-15 07:00"],
          ["2025-12-16 07:00","2025-12-17 19:00"],
          ["2025-12-24 19:00","2025-12-26 07:00"]
        ]},
        { nome:"Rafael", editando:false, periodos:[
          ["2025-12-06 19:00","2025-12-08 07:00"],
          ["2025-12-09 07:00","2025-12-10 19:00"],
          ["2025-12-17 19:00","2025-12-19 07:00"],
          ["2025-12-26 07:00","2025-12-27 19:00"]
        ]},
        { nome:"Vanderlei", editando:false, periodos:[] }
      ];

      // Abastecimento
      let motoristasDb = [];  // [{id, nome, ativo}]
      function getMotoristasAtivos() {
        return motoristasDb
          .filter(m => m.ativo !== false)
          .map(m => m.nome);
      }

      let placasDb = [];      // [{id, placa, ativo}]
      let abastecimentosData = []; // registros carregados

      let editingAbastId = null;

      // Servi√ßos Particulares
      let servicosData = [];
      let editingServicoId = null;

      function aplicarLockModais(){
      const estaLogado = !!currentUser;

      const modal = document.getElementById("modalEditarServico");

      if(!modal) return;

      if(estaLogado){
        modal.classList.remove("modal-locked");
      } else {
        modal.classList.add("modal-locked");
      }
    }



      // Categorias (Tabela)
      let categoriasMem = [...CATEGORIAS_FIXAS];

      // Comiss√£o
      let comissoesData = [];
      let editingComissaoId = null;

      // ========== UTIL GERAL ==========
      function pad2(n){ return n.toString().padStart(2,"0"); }

      function parseDateTime(str) {
    if (!str) return null;

    str = String(str).trim();

    // formato ISO
    let d = new Date(str);
    if (!isNaN(d)) return d;

    // formato "YYYY-MM-DD HH:MM"
    if (str.includes(" ")) {
        const [data, hora] = str.split(" ");
        const [Y, M, D] = data.split("-").map(Number);
        const [h, m] = hora.split(":").map(Number);
        d = new Date(Y, M - 1, D, h || 0, m || 0);
        if (!isNaN(d)) return d;
    }

    return null;
}



      function formatDateTime(dt) {
    if (!(dt instanceof Date) || isNaN(dt)) return "";
    return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}


      function formatMoneyBR(v){
        const n = Number(v||0);
        return n.toLocaleString("pt-BR", {minimumFractionDigits:2, maximumFractionDigits:2});
      }

      function todayIso(){
        const d = new Date();
        return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
      }

            // ========== TABS + FECHAR MENU MOBILE ==========
      document.querySelectorAll(".tab-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const target = btn.dataset.target;

          document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");

          document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
          document.getElementById(target).classList.add("active");

          // se estiver no mobile, fechar o menu ao trocar de aba
          const topbarEl = document.querySelector(".topbar");
          if(topbarEl && topbarEl.classList.contains("nav-open")){
            topbarEl.classList.remove("nav-open");
          }
        });
      });

            // ========== MENU HAMB√öRGUER (MOBILE) ==========
      const hamburgerBtn = document.getElementById("hamburgerBtn");
      const mobileNavBackdrop = document.getElementById("mobileNavBackdrop");
      const topbarEl = document.querySelector(".topbar");

      if(hamburgerBtn && mobileNavBackdrop && topbarEl){
        hamburgerBtn.addEventListener("click", ()=>{
          topbarEl.classList.toggle("nav-open");
          mobileNavBackdrop.classList.toggle("active");
        });

        mobileNavBackdrop.addEventListener("click", ()=>{
          topbarEl.classList.remove("nav-open");
          mobileNavBackdrop.classList.remove("active");
        });
      }



      // ========== TEMA ==========
      const darkToggle = document.getElementById("darkToggle");
      function applyThemeFromStorage(){
        if(localStorage.getItem("darkMode")==="1"){
          document.documentElement.classList.add("dark");
          darkToggle.checked = true;
        }
      }
      darkToggle.addEventListener("change", ()=>{
        if(darkToggle.checked){
          document.documentElement.classList.add("dark");
          localStorage.setItem("darkMode","1");
        } else {
          document.documentElement.classList.remove("dark");
          localStorage.removeItem("darkMode");
        }
      });
      applyThemeFromStorage();

      // ========== LOGIN / AUTH ==========
      const loginBackdrop = document.getElementById("loginBackdrop");
      const userChip = document.getElementById("userChip");
      const userChipText = document.getElementById("userChipText");
      const userStatusDot = document.getElementById("userStatusDot");
      const btnLoginTop = document.getElementById("btnLoginTop");
      const btnLogoutTop = document.getElementById("btnLogoutTop");
      const tabComissao = document.getElementById("tabComissao");
      const tabServicos = document.getElementById("tabServicos");


      window.openLoginModal = function(){
  const backdrop = document.getElementById("loginBackdrop");
  if(!backdrop){
    console.error("loginBackdrop n√£o encontrado");
    return;
  }

  backdrop.classList.add("active");
};

      window.closeLoginModal = function(){
  const backdrop = document.getElementById("loginBackdrop");
  if(backdrop){
    backdrop.classList.remove("active");
  }
};



      async function doLogin(){
        const email = document.getElementById("loginEmail").value.trim();
        const pass = document.getElementById("loginPass").value;
        const remember = document.getElementById("rememberMe").checked;
        const msg = document.getElementById("loginMsg");
        if(!email || !pass){
          msg.textContent = "Preencha email e senha.";
          return;
        }
        msg.textContent = "Entrando...";
        const res = await supabaseClient.auth.signInWithPassword({ email, password: pass });
        if(res.error){
          msg.textContent = res.error.message;
          return;
        }
        if(remember) localStorage.setItem("rememberMe","1");
        currentUser = res.data.user;
        closeLoginModal();
        updateAuthUI();
        alert("Logado com sucesso!");
      }

      async function logout(){
        await supabaseClient.auth.signOut();
        currentUser = null;
        localStorage.removeItem("rememberMe");
        updateAuthUI();
        alert("Voc√™ saiu da sua sess√£o.");
      }

      function updateAuthUI(){
        if(currentUser){
          document.getElementById("userChipText").textContent = currentUser.email;
          userStatusDot.style.background = "#22c55e";
          userStatusDot.style.boxShadow = "0 0 0 4px rgba(34,197,94,.3)";
          btnLoginTop.style.display = "none";
          btnLogoutTop.style.display = "inline-flex";

          // mostrar abas permitidas
          tabComissao.style.display = "inline-flex";
          tabServicos.style.display = "inline-flex";

        } else {
          userChipText.textContent = "N√£o conectado";
          userStatusDot.style.background = "#ef4444";
          userStatusDot.style.boxShadow = "0 0 0 4px rgba(239,68,68,.25)";
          btnLoginTop.style.display = "inline-flex";
          btnLogoutTop.style.display = "none";

          // esconder abas privadas
          tabComissao.style.display = "none";
          tabServicos.style.display = "none";

          // impedir usu√°rio n√£o logado de ficar numa aba privada
          const activePage = document.querySelector(".page.active")?.id;
          if(activePage === "page-comissao" || activePage === "page-servicos"){
            document.querySelector('[data-target="page-escala"]').click();
          }
        }

        applyAuthProtection();

        // üîì garantir que o bot√£o de Motoristas/Placas nunca fique disabled
const btnMP = document.getElementById("btnGerenciarMP");
if (btnMP) {
  btnMP.disabled = false;
  btnMP.classList.remove("btn-disabled");
}

      }


      function applyAuthProtection(){
        const logged = !!currentUser;
        document.querySelectorAll("[data-auth='protected']").forEach(el=>{
          el.disabled = !logged;
          el.classList.toggle("btn-disabled", !logged);
          if(!logged){
            el.title = "Fa√ßa login para usar esta a√ß√£o.";
          } else {
            el.removeAttribute("title");
          }
        });
      }

      async function restoreSession(){
        const s = await supabaseClient.auth.getSession();
        if(s && s.data && s.data.session){
          currentUser = s.data.session.user;
        }
        updateAuthUI();
      }

      // ========== GERENCIADOR MOTORISTAS / PLACAS ==========
      const mpBackdrop = document.getElementById("mpBackdrop");
      function openMpModal(){
  if(!currentUser){
    alert("Fa√ßa login para gerenciar motoristas e placas.");
    return;
  }

  const mpBackdrop = document.getElementById("mpBackdrop");
  if(!mpBackdrop){
    console.error("mpBackdrop n√£o encontrado");
    return;
  }

  mpBackdrop.classList.add("active");
  renderMotoristasPlacasUI();
}

function closeMpModal(){
  const mpBackdrop = document.getElementById("mpBackdrop");
  if(mpBackdrop){
    mpBackdrop.classList.remove("active");
  }
}


      async function refreshMotoristasPlacas(){
        await loadMotoristasPlacas();
        renderMotoristasPlacasUI();
      }

      async function loadMotoristasPlacas(){
        try{
          const { data: m, error: e1 } = await supabaseClient.from("motoristas").select("*").order("nome");
          const { data: p, error: e2 } = await supabaseClient.from("placas").select("*").order("placa");
          if(e1) console.error(e1);
          if(e2) console.error(e2);
          motoristasDb = (m||[]);
          placasDb = (p||[]);
          popularSelectMotoristasPlacas();
        } catch(e){
          console.error(e);
        }
      }

      function renderMotoristasPlacasUI(){
        const lm = document.getElementById("listaMotoristas");
        const lp = document.getElementById("listaPlacas");
        lm.innerHTML = "";
        lp.innerHTML = "";
        motoristasDb.forEach(m=>{
        const row = document.createElement("div");
        row.style.display="flex";
        row.style.justifyContent="space-between";
        row.style.alignItems="center";
        row.style.padding="3px 4px";
        row.style.borderBottom="1px solid rgba(148,163,184,0.25)";

        // Campo de edi√ß√£o inline
        row.innerHTML = `
          <input 
            type="text" 
            value="${m.nome}" 
            id="editMot_${m.id}" 
            style="flex:1; margin-right:6px; padding:4px;"
          >
          ${m.ativo===false ? "<span style='color:#f97316'>(inativo)</span>" : ""}
        `;

        // Bot√£o salvar edi√ß√£o
        const btnSalvar = document.createElement("button");
        btnSalvar.className = "btn btn-primary btn-sm";
        btnSalvar.textContent = "Salvar";
        btnSalvar.onclick = ()=> editarMotorista(m.id);
        row.appendChild(btnSalvar);

        // Bot√£o ativar / inativar
        const btnToggle = document.createElement("button");
        btnToggle.className = "btn btn-ghost btn-sm";
        btnToggle.textContent = m.ativo===false ? "Ativar" : "Inativar";
        btnToggle.onclick = ()=> toggleMotoristaAtivo(m.id, m.ativo===false);
        row.appendChild(btnToggle);

        lm.appendChild(row);
      });

        placasDb.forEach(p=>{
          const row = document.createElement("div");
          row.style.display="flex";
          row.style.justifyContent="space-between";
          row.style.alignItems="center";
          row.style.padding="3px 4px";
          row.style.borderBottom="1px solid rgba(148,163,184,0.25)";
          row.innerHTML = `<span>${p.placa}${p.ativo===false?" <span style='color:#f97316'>(inativa)</span>":""}</span>`;
          const b = document.createElement("button");
          b.className = "btn btn-ghost btn-sm";
          b.textContent = p.ativo===false?"Ativar":"Inativar";
          b.onclick = ()=> togglePlacaAtivo(p.id, p.ativo===false);
          row.appendChild(b);
          lp.appendChild(row);
        });
      }

      async function toggleMotoristaAtivo(id, novoAtivo){
        if(!currentUser){ alert("Fa√ßa login."); return; }
        await supabaseClient.from("motoristas").update({ativo:novoAtivo}).eq("id",id);
        await refreshMotoristasPlacas();
      }
      async function togglePlacaAtivo(id, novoAtivo){
        if(!currentUser){ alert("Fa√ßa login."); return; }
        await supabaseClient.from("placas").update({ativo:novoAtivo}).eq("id",id);
        await refreshMotoristasPlacas();
      }

      async function adicionarMotorista(){
        const nome = document.getElementById("novoMotorista").value.trim();
        if(!nome){ return; }
        await supabaseClient.from("motoristas").insert({nome, ativo:true});
        document.getElementById("novoMotorista").value="";
        await refreshMotoristasPlacas();
      }
      async function adicionarPlaca(){
        let placa = document.getElementById("novaPlaca").value.trim().toUpperCase();
        if(!placa){ return; }
        await supabaseClient.from("placas").insert({placa, ativo:true});
        document.getElementById("novaPlaca").value="";
        await refreshMotoristasPlacas();
      }

      function popularSelectMotoristasPlacas(){
        const ativosMotoristas = motoristasDb.filter(m=>m.ativo!==false).map(m=>m.nome);
        const ativosPlacas = placasDb.filter(p=>p.ativo!==false).map(p=>p.placa);

        const abastMot = document.getElementById("abastMotorista");
        const abastMotF = document.getElementById("abastFiltroMotorista");
        const abastPl = document.getElementById("abastPlaca");
        const abastPlF = document.getElementById("abastFiltroPlaca");

        abastMot.innerHTML = `<option value="">Selecione</option>`;
        ativosMotoristas.forEach(n=> abastMot.innerHTML += `<option value="${n}">${n}</option>`);
        abastMotF.innerHTML = `<option value="">Todos</option>` + ativosMotoristas.map(n=>`<option>${n}</option>`).join("");

        abastPl.innerHTML = `<option value="">Selecione</option>`;
        ativosPlacas.forEach(p=> abastPl.innerHTML += `<option value="${p}">${p}</option>`);
        abastPlF.innerHTML = `<option value="">Todas</option>` + ativosPlacas.map(p=>`<option>${p}</option>`).join("");
      }

      // ========== ESCALA ==========
      function gerarMesesEscala(){
        const sel = document.getElementById("escalaMesSelect");
        sel.innerHTML = "";
        const hoje = new Date();
        const primeiroAno = 2025, primeiroMes = 12;
        const start = new Date(Math.max(
          new Date(primeiroAno, primeiroMes-1, 1).getTime(),
          new Date(hoje.getFullYear(), hoje.getMonth(),1).getTime()
        ));
        const anoStart = start.getFullYear(), mesStart = start.getMonth()+1;

        for(let ano=anoStart; ano<=2026; ano++){
          for(let mes=(ano===anoStart?mesStart:1); mes<=12; mes++){
            const v = `${ano}-${pad2(mes)}`;
            const nome = new Date(ano, mes-1,1).toLocaleDateString("pt-BR",{month:"long"});
            const opt = document.createElement("option");
            opt.value = v;
            opt.textContent = `${nome} ${ano}`;
            sel.appendChild(opt);
          }
        }
        const atual = `${(new Date()).getFullYear()}-${pad2((new Date()).getMonth()+1)}`;
        const min = `2025-12`;
        sel.value = (atual < min ? min : atual);
      }

      function popularFuncionariosEscala(){
        const sel = document.getElementById("escalaFuncSelect");
        sel.innerHTML = '<option value="todos">Todos funcion√°rios</option>';
        folgas.forEach(f=>{
          const o = document.createElement("option");
          o.value = f.nome;
          o.textContent = f.nome;
          sel.appendChild(o);
        });
      }

      function estaDeFolga(periodos){
        const agora = new Date();
        return periodos.some(([ini,fim])=>{
          const a = parseDateTime(ini), b = parseDateTime(fim);
          return agora >= a && agora <= b;
        });
      }

      function montarListaEscala(){
        const filtroFunc = document.getElementById("escalaFuncSelect").value;
        const filtroMes = document.getElementById("escalaMesSelect").value;
        const container = document.getElementById("listaEscala");
        container.innerHTML = "";

        folgas.forEach(pessoa=>{
          if(filtroFunc !== "todos" && pessoa.nome !== filtroFunc) return;
          const mostrar = pessoa.periodos.filter(p=> filtroMes==="todos" || p[0].startsWith(filtroMes));
          // Sempre mostrar o cart√£o do funcion√°rio se ele estiver editando,
          // mesmo que o m√™s n√£o tenha folgas ainda
          if (mostrar.length===0 && !pessoa.editando) return;

          const card = document.createElement("div");
          card.className = "pessoa";

          const header = document.createElement("div");
          header.className = "pessoa-header";

          const nomeEl = document.createElement("div");
          nomeEl.className = "pessoa-nome";
          nomeEl.textContent = pessoa.nome;
          header.appendChild(nomeEl);

          const btnRow = document.createElement("div");
          if(!pessoa.editando){
            btnRow.innerHTML = `
              <button class="btn btn-soft btn-sm" onclick="copiarFolgas('${pessoa.nome}')">Copiar</button>
              <button class="btn btn-soft btn-sm" data-auth="protected" onclick="editarFolga('${pessoa.nome}')">Editar</button>
            `;
          }
          header.appendChild(btnRow);
          card.appendChild(header);

          const agoraFolga = estaDeFolga(pessoa.periodos);
          if(agoraFolga) card.classList.add("em-folga");

          const hoje = new Date();
          const prefixHoje = `${hoje.getFullYear()}-${pad2(hoje.getMonth()+1)}-${pad2(hoje.getDate())}`;
          if(mostrar.some(p => p[0].startsWith(prefixHoje) && parseDateTime(p[0]).getHours() >= 18)){
            card.classList.add("entra-hoje");
          }

          if(pessoa.editando){
            const nomeID = pessoa.nome.replace(/\s+/g,"_");
            mostrar.forEach((p,i)=>{
              const ini = parseDateTime(p[0]), fim = parseDateTime(p[1]);
              const box = document.createElement("div");
              box.style.cssText = "background:var(--card-soft);padding:8px;border-radius:9px;margin-top:6px;";

              box.innerHTML = `
                <div style="font-size:13px;font-weight:600;margin-bottom:4px;">Per√≠odo ${i+1}</div>
                <label>In√≠cio</label>
                <div class="stack-h">
                  <input type="date" id="iniData_${nomeID}_${i}" value="${ini.toISOString().slice(0,10)}" style="max-width:50%;">
                  <input type="time" id="iniHora_${nomeID}_${i}" value="${pad2(ini.getHours())}:${pad2(ini.getMinutes())}" style="max-width:40%;">
                </div>
                <label style="margin-top:4px;">Fim</label>
                <div class="stack-h">
                  <input type="date" id="fimData_${nomeID}_${i}" value="${fim.toISOString().slice(0,10)}" style="max-width:50%;">
                  <input type="time" id="fimHora_${nomeID}_${i}" value="${pad2(fim.getHours())}:${pad2(fim.getMinutes())}" style="max-width:40%;">
                </div>
                <div style="margin-top:6px;">
                  <button class="btn btn-danger btn-sm" data-auth="protected" onclick="removerFolgaFiltrada('${pessoa.nome}',${i})">Remover</button>
                </div>
              `;
              card.appendChild(box);
            });

            const actions = document.createElement("div");
            actions.className = "stack-h";
            actions.style.marginTop = "8px";
            actions.innerHTML = `
              <button class="btn btn-soft btn-sm" data-auth="protected" onclick="adicionarFolga('${pessoa.nome}')">Adicionar</button>
              <button class="btn btn-primary btn-sm" data-auth="protected" onclick="salvarEdicaoFolga('${pessoa.nome}')">Salvar</button>
              <button class="btn btn-ghost btn-sm" data-auth="protected" onclick="cancelarEdicaoFolga('${pessoa.nome}')">Cancelar</button>
            `;
            card.appendChild(actions);
          } else {
            mostrar.forEach((p,i)=>{
              const ini = parseDateTime(p[0]), fim = parseDateTime(p[1]);
              const item = document.createElement("div");
              item.className = "folga-item";
              item.innerHTML = `
                <div class="folga-data">üóì ${ini.toLocaleDateString("pt-BR")} ‚Üí ${fim.toLocaleDateString("pt-BR")}</div>
                <div class="folga-hora">‚è∞ Das ${ini.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})} √†s ${fim.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})}</div>
              `;
              card.appendChild(item);
            });
          }

          container.appendChild(card);
        });

        applyAuthProtection(); // para bot√µes din√¢micos
      }

      function editarFolga(nome){
        if(!currentUser){ alert("Fa√ßa login para editar."); return; }
        const f = folgas.find(x=>x.nome===nome);
        if(f){ f.editando = true; montarListaEscala(); }
      }
      function cancelarEdicaoFolga(nome){
        const f = folgas.find(x=>x.nome===nome);
        if(f){ f.editando = false; montarListaEscala(); }
      }

      function removerFolgaFiltrada(nome, idxFiltrado){
        if(!currentUser){ alert("Fa√ßa login."); return; }
        const filtroMes = document.getElementById("escalaMesSelect").value;
        const pessoa = folgas.find(f=>f.nome===nome);
        const filtrados = pessoa.periodos.filter(p=> p[0].startsWith(filtroMes));
        const periodo = filtrados[idxFiltrado];
        pessoa.periodos = pessoa.periodos.filter(p=> !(p[0]===periodo[0] && p[1]===periodo[1]));
        montarListaEscala();
      }

      function adicionarFolga(nome){
    if(!currentUser){
        alert("Fa√ßa login para adicionar folgas.");
        return;
    }

    const pessoa = folgas.find(f => f.nome === nome);
    const filtroMes = document.getElementById("escalaMesSelect").value;
    pessoa.editando = true;

    // Re-renderiza tudo para garantir a √°rea atualizada
    montarListaEscala();

    // Procurar o card pelo nome do funcion√°rio
    let card = null;
    const cards = document.querySelectorAll(".pessoa");
    cards.forEach(c => {
        const titulo = c.querySelector(".pessoa-nome")?.textContent.trim();
        if(titulo === nome){
            card = c;
        }
    });
    if (!card) {
        alert("Erro interno: card n√£o encontrado.");
        return;
    }

    // Contar quantos blocos j√° existem (para gerar IDs distintos)
    const existing = card.querySelectorAll(".folga-edit-box").length;
    const newIndex = existing; 

    // Criar o bloco de folga manual
    const box = document.createElement("div");
    box.className = "folga-edit-box";
    box.style.cssText = "background:var(--card-soft);padding:8px;border-radius:9px;margin-top:6px;";

    box.innerHTML = `
        <div style="font-size:13px;font-weight:600;margin-bottom:4px;">Nova Folga Manual</div>

        <label>In√≠cio</label>
        <div class="stack-h">
            <input type="date" id="iniData_${nome}_${newIndex}" style="max-width:50%;">
            <input type="time" id="iniHora_${nome}_${newIndex}" style="max-width:40%;">
        </div>

        <label style="margin-top:4px;">Fim</label>
        <div class="stack-h">
            <input type="date" id="fimData_${nome}_${newIndex}" style="max-width:50%;">
            <input type="time" id="fimHora_${nome}_${newIndex}" style="max-width:40%;">
        </div>

        <div style="margin-top:6px;">
            <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Remover</button>
        </div>
    `;

    // Inserir o bloco antes dos bot√µes (Salvar / Cancelar)
    const actions = card.querySelector(".stack-h:last-child");
    card.insertBefore(box, actions);
}

      async function salvarEdicaoFolga(nome){
    if(!currentUser){
        alert("Fa√ßa login.");
        return;
    }

    const pessoa = folgas.find(f => f.nome === nome);
    const filtroMes = document.getElementById("escalaMesSelect").value;

    const card = [...document.querySelectorAll(".pessoa")]
        .find(c => c.querySelector(".pessoa-nome")?.textContent.trim() === nome);

    if(!card) return;

    const inputs = card.querySelectorAll("input[type='date'], input[type='time']");
    const novos = [];

    // Capturar pares de entradas
    for(let i = 0; i < inputs.length; i += 4){
        const dIni = inputs[i].value;
        const hIni = inputs[i+1].value;
        const dFim = inputs[i+2].value;
        const hFim = inputs[i+3].value;

        if(!dIni || !hIni || !dFim || !hFim){
            alert("Preencha todos os campos antes de salvar.");
            return;
        }

        novos.push([`${dIni} ${hIni}`, `${dFim} ${hFim}`]);
    }

    pessoa.periodos = pessoa.periodos
        .filter(p => !p[0].startsWith(filtroMes))
        .concat(novos)
        .sort((a,b)=> parseDateTime(a[0]) - parseDateTime(b[0]));

    pessoa.editando = false;
    montarListaEscala();
    await salvarFolgasNoBanco();
}


      async function carregarFolgasDoBanco(){
        try{
          const { data, error } = await supabaseClient.from("folgas").select("*").order("inicio",{ascending:true});
          if(error){ console.error(error); alert("Erro ao carregar da nuvem."); return false; }
          if(!data || data.length===0){ montarListaEscala(); return false; }

          folgas.forEach(f=>f.periodos=[]);
          data.forEach(row=>{
            const pessoa = folgas.find(p=>p.nome===row.funcionario);
            if(pessoa) pessoa.periodos.push([row.inicio, row.fim]);
          });
          folgas.forEach(f=> f.periodos.sort((a,b)=> parseDateTime(a[0]) - parseDateTime(b[0])));

          popularFuncionariosEscala();
          montarListaEscala();
          return true;
        } catch(e){
          console.error(e);
          alert("Erro ao carregar folgas do Supabase.");
          return false;
        }
      }

      async function salvarFolgasNoBanco(){
        try{
          await supabaseClient.from("folgas").delete().neq("id",0);
          const linhas = [];
          folgas.forEach(f=>{
            f.periodos.forEach(p=>{
              linhas.push({funcionario:f.nome, inicio:p[0], fim:p[1]});
            });
          });
          if(linhas.length){
            const { error } = await supabaseClient.from("folgas").insert(linhas);
            if(error) throw error;
          }
          alert("Escala salva na nuvem.");
        } catch(e){
          console.error(e);
          alert("Erro ao salvar escala na nuvem.");
        }
      }

      function copiarFolgas(nome){
        const f = folgas.find(x=>x.nome===nome);
        const filtroMes = document.getElementById("escalaMesSelect").value;
        let lista = f.periodos;
        if(filtroMes!=="todos") lista = lista.filter(p=>p[0].startsWith(filtroMes));
        if(lista.length===0){ alert("Sem folgas no m√™s selecionado."); return; }
        let ref = lista[0][0].slice(5,7)+"/"+lista[0][0].slice(0,4);
        let txt = `Ol√° ${f.nome}! Aqui est√° sua escala de folgas para ${ref}:\n\n` +
          lista.map(p=>`- ${p[0]} at√© ${p[1]}`).join("\n");
        navigator.clipboard.writeText(txt).then(()=> alert("Copiado para a √°rea de transfer√™ncia.")).catch(()=> alert("N√£o foi poss√≠vel copiar."));
      }

      function mostrarFolgasAgora(){
        const em = folgas.filter(f=>estaDeFolga(f.periodos));
        if(em.length===0) alert("Ningu√©m est√° de folga agora.");
        else alert("Em folga:\n" + em.map(x=>x.nome).join("\n"));
      }

      // PDF escala
      async function gerarPDFFuncionarioMes(){
        if(!currentUser){ alert("Fa√ßa login para gerar o PDF."); return; }
        const funcSel = document.getElementById("escalaFuncSelect").value;
        if(funcSel==="todos"){ alert("Selecione um funcion√°rio nos filtros."); return; }
        const mes = document.getElementById("escalaMesSelect").value;
        const pessoa = folgas.find(f=>f.nome===funcSel);
        if(!pessoa){ alert("Funcion√°rio n√£o encontrado."); return; }
        const rows = pessoa.periodos.filter(p=> p[0].startsWith(mes));
        if(rows.length===0){ alert("Sem folgas no m√™s selecionado."); return; }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({unit:'pt', format:'a4'});
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFontSize(14);
        doc.text("Escala de Folgas", pageWidth/2, 40, { align:"center" });
        doc.setFontSize(11);
        doc.text(`Funcion√°rio: ${pessoa.nome}`, 40, 70);
        doc.text(`M√™s/Ano: ${mes.slice(5,7)}/${mes.slice(0,4)}`, 40, 88);

        const body = rows.map(r=>{
          const ini = parseDateTime(r[0]), fim = parseDateTime(r[1]);
          return [
            ini.toLocaleDateString("pt-BR"),
            `${ini.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})} ‚Üí ${fim.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})}`,
            `${r[0]} at√© ${r[1]}`
          ];
        });

        doc.autoTable({
          startY:110,
          head:[["Data","Hor√°rio","Per√≠odo (texto bruto)"]],
          body,
          styles:{fontSize:10},
          headStyles:{fillColor:[25,103,210]}
        });

        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 40 : 300;
        doc.setFontSize(11);
        doc.text("Respons√°vel Administrativo: ____________________________", 40, finalY+20);
        doc.text("(campo em branco para editar futuramente)", 42, finalY+36);
        doc.text(`Funcion√°rio (${pessoa.nome}): ____________________________`, 40, finalY+80);

        const nomeArquivo = `Escala_${pessoa.nome.replace(/\s+/g,'_')}_${mes}.pdf`;
        doc.save(nomeArquivo);
      }

      // Notifica√ß√µes locais
      async function requestNotificationPermission(){ 
        if(!("Notification" in window)) return false;
        if(Notification.permission === "granted") return true;
        if(Notification.permission !== "denied"){
          const p = await Notification.requestPermission();
          return p === "granted";
        }
        return false;
      }
      async function scheduleLocalReminders(){
        if(!await requestNotificationPermission()){
          alert("Permiss√£o de notifica√ß√µes negada.");
          return;
        }
        const now = new Date();
        folgas.forEach(p=>{
          p.periodos.forEach(pr=>{
            const ini = parseDateTime(pr[0]);
            const fim = parseDateTime(pr[1]);
            const antesIni = new Date(ini.getTime() - 12*60*60*1000);
            if(antesIni > now){
              setTimeout(()=> new Notification(`${p.nome} entra em folga`, { body:`Come√ßa em ${ini.toLocaleString("pt-BR")}` }), antesIni - now);
            }
            const antesFim = new Date(fim.getTime() - 12*60*60*1000);
            if(antesFim > now){
              setTimeout(()=> new Notification(`${p.nome} volta da folga`, { body:`Volta em ${fim.toLocaleString("pt-BR")}` }), antesFim - now);
            }
          });
        });
        alert("Lembretes locais agendados (apenas enquanto a aba estiver aberta).");
      }

      // ========== ABASTECIMENTO ==========
      function recalcularAbastecimentoCampos(){
        const kmAnt = Number(document.getElementById("abastKmAnt").value||0);
        const kmAt = Number(document.getElementById("abastKmAtual").value||0);
        const litros = Number(document.getElementById("abastLitros").value||0);
        const vl = Number(document.getElementById("abastValorLitro").value||0);
        const total = litros * vl;
        const dif = kmAt - kmAnt;
        const media = litros>0 ? dif / litros : 0;
        document.getElementById("abastTotal").value = formatMoneyBR(total);
        document.getElementById("abastMedia").value = media>0 ? media.toFixed(2) : "";
      }

      ["abastKmAnt","abastKmAtual","abastLitros","abastValorLitro"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener("input", recalcularAbastecimentoCampos);
      });

      function limparFormularioAbast(){
        editingAbastId = null;
        document.getElementById("abastModeLabel").textContent = "Modo: novo lan√ßamento";
        document.getElementById("abastData").value = todayIso();
        document.getElementById("abastPlaca").value = "";
        document.getElementById("abastMotorista").value = "";
        document.getElementById("abastCombustivel").value = "Diesel";
        document.getElementById("abastKmAnt").value = "";
        document.getElementById("abastKmAtual").value = "";
        document.getElementById("abastLitros").value = "";
        document.getElementById("abastValorLitro").value = "";
        document.getElementById("abastTotal").value = "";
        document.getElementById("abastMedia").value = "";
      }

      async function salvarAbastecimento(){
        if(!currentUser){ alert("Fa√ßa login para lan√ßar abastecimentos."); return; }
        const data = document.getElementById("abastData").value;
        const placa = document.getElementById("abastPlaca").value;
        const motorista = document.getElementById("abastMotorista").value;
        const combustivel = document.getElementById("abastCombustivel").value;
        const kmAnt = Number(document.getElementById("abastKmAnt").value||0);
        const kmAt = Number(document.getElementById("abastKmAtual").value||0);
        const litros = Number(document.getElementById("abastLitros").value||0);
        const valorLitro = Number(document.getElementById("abastValorLitro").value||0);

        if(!data || !placa || !motorista){
          alert("Preencha data, placa e motorista.");
          return;
        }
        if(kmAt <= kmAnt){
          alert("KM atual deve ser maior que KM anterior.");
          return;
        }

        const total = litros * valorLitro;
        const media = litros>0 ? (kmAt - kmAnt)/litros : 0;

        try{
          if(editingAbastId){
            const { error } = await supabaseClient.from("abastecimentos").update({
              data, placa, motorista, combustivel,
              km_anterior: kmAnt, km_atual:kmAt,
              litros, valor_litro:valorLitro,
              total, media
            }).eq("id",editingAbastId);
            if(error) throw error;
            alert("Abastecimento atualizado.");
          } else {
            const { error } = await supabaseClient.from("abastecimentos").insert({
            data,
            placa,
            motorista,
            combustivel,
            km_anterior: kmAnt,   // <-- CORRETO
            km_atual: kmAt,
            litros,
            valor_litro: valorLitro,
            total,
            media
          });

            if(error) throw error;
            alert("Abastecimento salvo.");
          }
          limparFormularioAbast();
          await loadAbastecimentos();
        } catch(e){
          console.error(e);
          alert("Erro ao salvar abastecimento.");
        }
      }

      async function gerarRelatorioAbastecimento() {
  // Usa os filtros atualmente aplicados
  const di = document.getElementById("abastFiltroDataIni").value;
  const df = document.getElementById("abastFiltroDataFim").value;
  const placa = document.getElementById("abastFiltroPlaca").value;
  const mot = document.getElementById("abastFiltroMotorista").value;

  let arr = [...abastecimentosData];
  if (di) arr = arr.filter(r => r.data >= di);
  if (df) arr = arr.filter(r => r.data <= df);
  if (placa) arr = arr.filter(r => r.placa === placa);
  if (mot) arr = arr.filter(r => r.motorista === mot);

  if (arr.length === 0) {
    alert("Nenhum registro encontrado com os filtros aplicados.");
    return;
  }

  // C√°lculo dos totais
  const totalGasto = arr.reduce((s, r) => s + Number(r.total || 0), 0);
  const totalLitros = arr.reduce((s, r) => s + Number(r.litros || 0), 0);

  const totalKmRodado = arr.reduce((s, r) => {
    const ant = Number(r.km_ant || 0);
    const at = Number(r.km_atual || 0);
    const dif = at - ant;
    return dif > 0 ? s + dif : s;
  }, 0);

  const mediaGeral = totalLitros > 0 ? (totalKmRodado / totalLitros) : 0;

  // ===== GERAR PDF =====
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const pageWidth = doc.internal.pageSize.getWidth();

  doc.setFontSize(16);
  doc.text("Relat√≥rio de Abastecimentos", pageWidth / 2, 40, { align: "center" });

  doc.setFontSize(11);
  doc.text(`Data inicial: ${di || "‚Äî"}`, 40, 70);
  doc.text(`Data final: ${df || "‚Äî"}`, 40, 85);
  doc.text(`Placa: ${placa || "Todas"}`, 40, 100);
  doc.text(`Motorista: ${mot || "Todos"}`, 40, 115);

  doc.setFontSize(12);
  doc.text("Resumo Geral:", 40, 150);

  doc.setFontSize(11);
  doc.text(`Total gasto: R$ ${formatMoneyBR(totalGasto)}`, 60, 170);
  doc.text(`Litros total: ${totalLitros.toFixed(2)} L`, 60, 185);
  doc.text(`KM total rodado: ${totalKmRodado} km`, 60, 200);
  doc.text(`M√©dia geral: ${mediaGeral.toFixed(2)} km/L`, 60, 215);
  doc.text(`Registros: ${arr.length}`, 60, 230);

  // Tabela detalhada
  const body = arr.map(r => ([
    r.data,
    r.placa,
    r.motorista,
    r.combustivel,
    r.litros,
    formatMoneyBR(r.total),
    r.media ? Number(r.media).toFixed(2) : ""
  ]));

  doc.autoTable({
    startY: 260,
    head: [["Data", "Placa", "Motorista", "Comb.", "Litros", "Total (R$)", "M√©dia"]],
    body,
    styles: { fontSize: 9 },
    headStyles: { fillColor: [25, 103, 210] }
  });

  const nomePDF = `Relatorio_Abastecimentos_${Date.now()}.pdf`;
  doc.save(nomePDF);
}

function getUltimoKmDaPlaca(placa) {
  if (!placa) return 0;

  // Filtra s√≥ abastecimentos da placa
  const lista = abastecimentosData
    .filter(a => a.placa === placa)
    .sort((a, b) => (a.data + a.hora) > (b.data + b.hora) ? -1 : 1);

  if (lista.length === 0) return 0;

  return Number(lista[0].km_atual || 0);
}

function autoKmAnterior() {
  const placa = document.getElementById("abastPlaca").value;
  const kmAnt = getUltimoKmDaPlaca(placa);

  if (kmAnt > 0) {
    document.getElementById("abastKmAnt").value = kmAnt;
  }
}




      async function loadAbastecimentos(){
        try{
          const { data, error } = await supabaseClient.from("abastecimentos")
            .select("*").order("data",{ascending:false}).order("id",{ascending:false});
          if(error) throw error;
          abastecimentosData = data||[];
          renderTabelaAbastecimentos();
        } catch(e){
          console.error(e);
          alert("Erro ao carregar abastecimentos.");
        }
      }

      function renderTabelaAbastecimentos(filtrados){
        const body = document.getElementById("abastecimentoTabelaBody");
        body.innerHTML = "";
        const arr = filtrados || abastecimentosData;
        arr.forEach(reg=>{
          const tr = document.createElement("tr");
          const dt = reg.data;
          tr.innerHTML = `
            <td>${dt}</td>
            <td>${reg.placa||""}</td>
            <td>${reg.motorista||""}</td>
            <td>${reg.combustivel||""}</td>
            <td>${reg.km_ant ?? ""}</td>
            <td>${reg.km_atual ?? ""}</td>
            <td>${reg.litros ?? ""}</td>
            <td>${reg.valor_litro ?? ""}</td>
            <td>${formatMoneyBR(reg.total)}</td>
            <td>${reg.media ? Number(reg.media).toFixed(2) : ""}</td>
            <td>
              <button class="btn btn-soft btn-sm" data-auth="protected" onclick="editarAbastecimento(${reg.id})">Editar</button>
              <button class="btn btn-danger btn-sm" data-auth="protected" onclick="excluirAbastecimento(${reg.id})">Excluir</button>
            </td>
          `;
          body.appendChild(tr);
        });
        applyAuthProtection();
      }

      function aplicarFiltroAbastecimento(){
        const di = document.getElementById("abastFiltroDataIni").value;
        const df = document.getElementById("abastFiltroDataFim").value;
        const placa = document.getElementById("abastFiltroPlaca").value;
        const mot = document.getElementById("abastFiltroMotorista").value;

        let arr = [...abastecimentosData];
        if(di) arr = arr.filter(r=> r.data >= di);
        if(df) arr = arr.filter(r=> r.data <= df);
        if(placa) arr = arr.filter(r=> r.placa===placa);
        if(mot) arr = arr.filter(r=> r.motorista===mot);
        renderTabelaAbastecimentos(arr);
      }

      function limparFiltroAbastecimento(){
        document.getElementById("abastFiltroDataIni").value = "";
        document.getElementById("abastFiltroDataFim").value = "";
        document.getElementById("abastFiltroPlaca").value = "";
        document.getElementById("abastFiltroMotorista").value = "";
        renderTabelaAbastecimentos();
      }

      function editarAbastecimento(id){
        if(!currentUser){ alert("Fa√ßa login."); return; }
        const reg = abastecimentosData.find(r=>r.id===id);
        if(!reg) return;
        editingAbastId = id;
        document.getElementById("abastModeLabel").textContent = "Modo: editando registro";
        document.getElementById("abastData").value = reg.data || todayIso();
        document.getElementById("abastPlaca").value = reg.placa||"";
        document.getElementById("abastMotorista").value = reg.motorista||"";
        document.getElementById("abastCombustivel").value = reg.combustivel||"Diesel";
        document.getElementById("abastKmAnt").value = reg.km_ant ?? "";
        document.getElementById("abastKmAtual").value = reg.km_atual ?? "";
        document.getElementById("abastLitros").value = reg.litros ?? "";
        document.getElementById("abastValorLitro").value = reg.valor_litro ?? "";
        recalcularAbastecimentoCampos();
        document.querySelector('[data-target="page-abastecimento"]').click();
      }

      async function excluirAbastecimento(id){
        if(!currentUser){ alert("Fa√ßa login."); return; }
        if(!confirm("Deseja realmente excluir este abastecimento?")) return;
        try{
          const { error } = await supabaseClient.from("abastecimentos").delete().eq("id",id);
          if(error) throw error;
          alert("Exclu√≠do.");
          await loadAbastecimentos();
        } catch(e){
          console.error(e);
          alert("Erro ao excluir.");
        }
      }

      // ========== CALCULADORA ==========
      function preencherCombosCalculadora(){
        const catSel = document.getElementById("calcCategoria");
        catSel.innerHTML = "";
        categoriasMem.forEach(c=>{
          const opt = document.createElement("option");
          opt.value = c.categoria;
          opt.textContent = c.categoria;
          catSel.appendChild(opt);
        });

        const motSel = document.getElementById("calcServMotorista");
          motSel.innerHTML = "";
          getMotoristasAtivos().forEach(n => {
            motSel.innerHTML += `<option>${n}</option>`;
          });


        const placaEmp = document.getElementById("calcServPlacaEmp");
        placaEmp.innerHTML = "";
        PLACAS_FIXAS.forEach(p=>{
          placaEmp.innerHTML += `<option>${p}</option>`;
        });

        document.getElementById("calcServData").value = todayIso();
        aplicarCategoriaNaCalculadora();
        document.getElementById("calcCategoria").addEventListener("change", aplicarCategoriaNaCalculadora);
      }

      function aplicarCategoriaNaCalculadora(){
        const catNome = document.getElementById("calcCategoria").value;
        const cat = categoriasMem.find(c=>c.categoria===catNome);
        if(cat){
          document.getElementById("calcValorKm").value = cat.valor_km.toFixed(2);
          document.getElementById("calcValorSaida").value = cat.valor_saida.toFixed(2);
        }
      }

      function fmtBr(n){
        const v = Number(n||0);
        return v.toLocaleString("pt-BR", {minimumFractionDigits:2, maximumFractionDigits:2});
      }

      function calcularServico(){
        let km_total = Number((document.getElementById("calcKmTotal").value||"0").replace(",","."));
        if(isNaN(km_total) || km_total<=0){
          alert("KM total inv√°lido.");
          return;
        }
        let valor_km = Number((document.getElementById("calcValorKm").value||"0").replace(",","."));
        let valor_saida = Number((document.getElementById("calcValorSaida").value||"0").replace(",","."));
        let preco_comb = Number((document.getElementById("calcPrecoComb").value||"0").replace(",","."));
        let pedagios = Number((document.getElementById("calcPedagios").value||"0").replace(",","."));

        let km_por_l = null;
        const media_txt = document.getElementById("calcMediaKmL").value.trim().replace(",",".");
        if(media_txt){
          const v = Number(media_txt);
          if(!isNaN(v) && v>0) km_por_l = v;
        }

        let km_para_calculo = Math.max(0, km_total - 40);
        let cobranca = (km_para_calculo * valor_km) + valor_saida + pedagios;
        let comissao = cobranca * 0.06;

        let litros = null;
        let custo_combustivel = 0;
        if(km_por_l){
          litros = km_total / km_por_l;
          custo_combustivel = litros * preco_comb;
        }

        let lucro = cobranca - comissao - custo_combustivel - pedagios;

        const out = [];
        out.push(`Origem: ${document.getElementById("calcOrigem").value.trim()}`);
        out.push(`Destino: ${document.getElementById("calcDestino").value.trim()}`);
        out.push(`KM total: ${fmtBr(km_total)} km`);
        out.push(`KM descontados (40km): ${fmtBr(km_para_calculo)} km`);
        out.push(`Valor por KM: R$ ${fmtBr(valor_km)}`);
        out.push(`Valor sa√≠da (40km): R$ ${fmtBr(valor_saida)}`);
        out.push("=== Cobran√ßa ===");
        out.push(`Total cobrado ao cliente: R$ ${fmtBr(cobranca)}`);
        out.push("=== Custos ===");
        if(km_por_l){
          out.push(`M√©dia informada: ${fmtBr(km_por_l)} km/L`);
          out.push(`Litros estimados: ${fmtBr(litros)} L`);
          out.push(`Custo combust√≠vel: R$ ${fmtBr(custo_combustivel)}`);
        } else {
          out.push("M√©dia n√£o informada ‚Äî c√°lculo combust√≠vel ignorado");
        }
        out.push(`Ped√°gios: R$ ${fmtBr(pedagios)}`);
        out.push(`Comiss√£o do motorista (6%): R$ ${fmtBr(comissao)}`);
        out.push("=== Resultado ===");
        out.push(`Lucro aproximado: R$ ${fmtBr(lucro)}`);

        document.getElementById("calcResultado").value = out.join("\n");

        // joga valor total na parte de servi√ßo particular por conveni√™ncia
        document.getElementById("calcServValorTotal").value = cobranca.toFixed(2);
      }

      // ========== TABELA CATEGORIAS ==========
      async function carregarCategorias(){
        try{
          const { data, error } = await supabaseClient.from("categorias").select("*").order("categoria");
          if(error){
            console.warn("Erro carregando categorias, usando padr√£o:", error.message);
            categoriasMem = [...CATEGORIAS_FIXAS];
          } else {
            if(!data || data.length===0){
              categoriasMem = [...CATEGORIAS_FIXAS];
            } else {
              categoriasMem = data.map(r=>({
                id:r.id,
                categoria:r.categoria,
                valor_km:Number(r.valor_km),
                valor_saida:Number(r.valor_saida)
              }));
            }
          }
        } catch(e){
          console.error(e);
          categoriasMem = [...CATEGORIAS_FIXAS];
        }
        renderCategoriasTabela();
        preencherCombosCalculadora();
        preencherCombosComissao();
      }

      function renderCategoriasTabela(){
        const body = document.getElementById("tabelaCategoriasBody");
        body.innerHTML = "";
        categoriasMem.forEach((c,idx)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><input type="text" value="${c.categoria}" oninput="editarCategoriaCampo(${idx}, 'categoria', this.value)"></td>
            <td><input type="number" step="0.01" value="${c.valor_saida}" oninput="editarCategoriaCampo(${idx}, 'valor_saida', this.value)"></td>
            <td><input type="number" step="0.01" value="${c.valor_km}" oninput="editarCategoriaCampo(${idx}, 'valor_km', this.value)"></td>
            <td>
              <button class="btn btn-danger btn-sm" data-auth="protected" onclick="removerCategoria(${idx})">Remover</button>
            </td>
          `;
          body.appendChild(tr);
        });
        applyAuthProtection();
      }

      function editarCategoriaCampo(idx, campo, valor){
        if(campo==="categoria"){
          categoriasMem[idx].categoria = valor;
        }else{
          categoriasMem[idx][campo] = Number((valor||"0").replace(",","."));
        }
      }

      function removerCategoria(idx){
        categoriasMem.splice(idx,1);
        renderCategoriasTabela();
        preencherCombosCalculadora();
        preencherCombosComissao();
      }

      function adicionarCategoriaLocal(){
        categoriasMem.push({categoria:"Nova", valor_km:0, valor_saida:0});
        renderCategoriasTabela();
        preencherCombosCalculadora();
        preencherCombosComissao();
      }

      async function salvarCategoriasNoBanco() {
  if (!currentUser) {
    alert("Fa√ßa login para salvar.");
    return;
  }

  try {
    // 1. Carregar categorias existentes do banco
    const { data: existentes, error: loadError } = await supabaseClient
      .from("categorias")
      .select("id");

    if (loadError) throw loadError;

    const idsExistentes = existentes.map(c => c.id);
    const idsMemoria = categoriasMem.map(c => c.id).filter(id => id);

    // 2. Descobrir quais devem ser removidas (estavam no banco mas n√£o est√£o mais na mem√≥ria)
    const idsParaRemover = idsExistentes.filter(id => !idsMemoria.includes(id));

    // REMOVER categorias deletadas no painel
    if (idsParaRemover.length > 0) {
      await supabaseClient
        .from("categorias")
        .delete()
        .in("id", idsParaRemover);
    }

    // 3. Salvar altera√ß√µes
    for (const cat of categoriasMem) {
      // NOVA categoria (n√£o tem id)
      if (!cat.id) {
        const { data, error } = await supabaseClient
          .from("categorias")
          .insert({
            categoria: cat.categoria,
            valor_km: cat.valor_km,
            valor_saida: cat.valor_saida,
            user_id: currentUser.id
          })
          .select()
          .single();

        if (!error) {
          cat.id = data.id; // salvar ID para evitar duplica√ß√£o
        }

      } else {
        // UPDATE categoria existente
        await supabaseClient
          .from("categorias")
          .update({
            categoria: cat.categoria,
            valor_km: cat.valor_km,
            valor_saida: cat.valor_saida
          })
          .eq("id", cat.id);
      }
    }

    alert("Categorias salvas com sucesso.");

    // Recarrega da base para garantir sincroniza√ß√£o perfeita
    carregarCategorias();

  } catch (e) {
    console.error(e);
    alert("Erro ao salvar categorias.");
  }
}


      // ========== COMISS√ÉO ==========
      function preencherCombosComissao(){
        const funcSel = document.getElementById("comFuncionario");
          funcSel.innerHTML = "";
          getMotoristasAtivos().forEach(n => {
            funcSel.innerHTML += `<option>${n}</option>`;
          });


        const placaSel = document.getElementById("comPlaca");
        const placaFiltro = document.getElementById("comFiltroPlaca");
        placaSel.innerHTML = "";
        placaFiltro.innerHTML = `<option value="">Todas</option>`;
        PLACAS_FIXAS.forEach(p=>{
          placaSel.innerHTML += `<option>${p}</option>`;
          placaFiltro.innerHTML += `<option>${p}</option>`;
        });

        const segSel = document.getElementById("comSeguradora");
        const segFiltro = document.getElementById("comFiltroSeg");
        segSel.innerHTML = "";
        segFiltro.innerHTML = `<option value="">Todas</option>`;
        SEGURADORAS_FIXAS.forEach(s=>{
          segSel.innerHTML += `<option>${s}</option>`;
          segFiltro.innerHTML += `<option>${s}</option>`;
        });

        const empSel = document.getElementById("comEmpresa");
        const empFiltro = document.getElementById("comFiltroEmp");
        empSel.innerHTML = "";
        empFiltro.innerHTML = `<option value="">Todas</option>`;
        EMPRESAS_FIXAS.forEach(e=>{
          empSel.innerHTML += `<option>${e}</option>`;
          empFiltro.innerHTML += `<option>${e}</option>`;
        });

        const catSel = document.getElementById("comCategoria");
        catSel.innerHTML = "";
        categoriasMem.forEach(c=>{
          catSel.innerHTML += `<option>${c.categoria}</option>`;
        });

        const funcFiltro = document.getElementById("comFiltroFunc");
          funcFiltro.innerHTML = `<option value="">Todos</option>`;
          getMotoristasAtivos().forEach(n => {
            funcFiltro.innerHTML += `<option>${n}</option>`;
          });


        document.getElementById("comData").value = todayIso();

        document.getElementById("comCategoria").addEventListener("change", calcularValorComissao);
        document.getElementById("comKmTotal").addEventListener("input", calcularValorComissao);
      }

      function calcularValorComissao(){
    const km_total = Number((document.getElementById("comKmTotal").value || "0").replace(",", "."));
    const categoria = document.getElementById("comCategoria").value;
    const catDetalhe = categoriasMem.find(c => c.categoria === categoria) || CATEGORIAS_FIXAS.find(c => c.categoria === categoria);

    if (!catDetalhe || km_total <= 0) {
        document.getElementById("comValorCalc").value = "";
        return;
    }

    let valor = 0;

    // Verificando se a categoria √© "T√°xi"
    if (categoria.toLowerCase() === "t√°xi" || categoria.toLowerCase() === "taxi") {
        valor = km_total * 1.70;
    } 
    // Verificando se a categoria √© "Leil√£o"
    else if (categoria.toLowerCase() === "leil√£o" || categoria.toLowerCase() === "leilao") {
        valor = km_total * 120; // Multiplica o km total por 120
    } 
    // Para as outras categorias
    else {
        const [vk, vs] = [catDetalhe.valor_km, catDetalhe.valor_saida];
        const km_para_calculo = Math.max(0, km_total - 40);
        valor = vs + km_para_calculo * vk;
    }

    document.getElementById("comValorCalc").value = formatMoneyBR(valor);
}

      
      

      function limparFormularioComissao(){
        editingComissaoId = null;
        document.getElementById("comissaoModoLabel").textContent = "Modo: novo lan√ßamento";
        document.getElementById("comData").value = todayIso();

        // Motoristas do Supabase
        const ativos = getMotoristasAtivos();
        document.getElementById("comFuncionario").value = ativos[0] || "";

        document.getElementById("comCategoria").value = categoriasMem[0]?.categoria || "T√°xi";
        document.getElementById("comKmTotal").value = "";

        // Placas continuam fixas (por enquanto)
        document.getElementById("comPlaca").value = PLACAS_FIXAS[0];

        document.getElementById("comOrigem").value = "";
        document.getElementById("comDestino").value = "";

        document.getElementById("comSeguradora").value = SEGURADORAS_FIXAS[0];
        document.getElementById("comEmpresa").value = EMPRESAS_FIXAS[0];

        document.getElementById("comValorCalc").value = "";
      }


      async function salvarComissao(){
        if(!currentUser){ alert("Fa√ßa login para salvar comiss√µes."); return; }
        const data = document.getElementById("comData").value;
        const func = document.getElementById("comFuncionario").value;
        const categoria = document.getElementById("comCategoria").value;
        const km_total = Number((document.getElementById("comKmTotal").value||"0").replace(",","."));
        const placa = document.getElementById("comPlaca").value;
        const origem = document.getElementById("comOrigem").value.trim();
        const destino = document.getElementById("comDestino").value.trim();
        const seguradora = document.getElementById("comSeguradora").value;
        const empresa = document.getElementById("comEmpresa").value;
      
       

        if(!data || !func || !categoria || !km_total || !origem || !destino || !seguradora || !empresa){
          alert("Preencha todos os campos obrigat√≥rios.");
          return;
        }

        const catDetalhe = categoriasMem.find(c=>c.categoria===categoria) || CATEGORIAS_FIXAS.find(c=>c.categoria===categoria);
        if(!catDetalhe){
          alert("Categoria inv√°lida.");
          return;
        }

        let valor = 0;
        // Regras especiais
          const catLower = categoria.toLowerCase();

          if(catLower === "t√°xi" || catLower === "taxi"){
              valor = km_total * 1.70;
          }
          else if(catLower === "leil√£o" || catLower === "leilao"){
              // ‚≠ê REGRA DO LEIL√ÉO = 120 √ó n√∫mero de carros (campo KM total)
              valor = km_total * 120;
          }
          else {
              // Regras normais
              const [vk, vs] = [catDetalhe.valor_km, catDetalhe.valor_saida];
              const km_para_calculo = Math.max(0, km_total - 40);
              valor = vs + km_para_calculo * vk;
          }


        try{
          if(editingComissaoId){
            const { error } = await supabaseClient.from("comissoes").update({
              data, funcionario:func, categoria, km_total,
              placa, origem, destino,
              seguradora, empresa,
              valor_total:valor,
              
              
            }).eq("id",editingComissaoId);
            if(error) throw error;
            alert("Comiss√£o atualizada.");
          } else {
            const { error } = await supabaseClient.from("comissoes").insert({
              data, funcionario:func, categoria, km_total,
              placa, origem, destino,
              seguradora, empresa,
              valor_total:valor,
              
             
            });
            if(error) throw error;
            alert("Comiss√£o salva.");
          }
          limparFormularioComissao();
          await carregarComissoes();
        } catch(e){
          console.error(e);
          alert("Erro ao salvar comiss√£o.");
        }
      }

      async function carregarComissoes(){
        try{
          const { data, error } = await supabaseClient.from("comissoes").select("*").order("data",{ascending:false}).order("id",{ascending:false});
          if(error) throw error;
          comissoesData = data||[];
          renderTabelaComissoes();
        } catch(e){
          console.error(e);
          alert("Erro ao carregar comiss√µes.");
        }
      }

      function renderTabelaComissoes(filtrados){
        const body = document.getElementById("comissaoTabelaBody");
        body.innerHTML = "";
        const arr = filtrados || comissoesData;
        arr.forEach(reg=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${reg.data||""}</td>
            <td>${reg.funcionario||""}</td>
            <td>${reg.categoria||""}</td>
            <td>${reg.km_total ?? ""}</td>
            <td>${reg.placa||""}</td>
            <td>${reg.origem||""}</td>
            <td>${reg.destino||""}</td>
            <td>${reg.seguradora||""}</td>
            <td>${reg.empresa||""}</td>
            <td>${formatMoneyBR(reg.valor_total)}</td>
            <td>
              ${reg.categoria === "Particular"
                ? `<span class="badge badge-lock">Servi√ßo Particular</span>`
                : `<button class="btn btn-soft btn-sm" data-auth="protected"
                    onclick="editarComissao('${reg.id}')">üìù</button>`
              }
              <button class="btn btn-danger btn-sm" data-auth="protected"
                onclick="excluirComissao('${reg.id}')">üóëÔ∏è</button>
            </td>

          `;

          body.appendChild(tr);
        });
        applyAuthProtection();
      }

      function aplicarFiltroComissao(){
        const di = document.getElementById("comFiltroDataIni").value;
        const df = document.getElementById("comFiltroDataFim").value;
        const func = document.getElementById("comFiltroFunc").value;
        const placa = document.getElementById("comFiltroPlaca").value;
        const origem = document.getElementById("comFiltroOrigem").value.trim().toLowerCase();
        const seg = document.getElementById("comFiltroSeg").value;
        const emp = document.getElementById("comFiltroEmp").value;

        let arr = [...comissoesData];
        if(di) arr = arr.filter(r=> r.data >= di);
        if(df) arr = arr.filter(r=> r.data <= df);
        if(func) arr = arr.filter(r=> r.funcionario===func);
        if(placa) arr = arr.filter(r=> r.placa===placa);
        if(origem) arr = arr.filter(r=> (r.origem||"").toLowerCase().includes(origem));
        if(seg) arr = arr.filter(r=> r.seguradora===seg);
        if(emp) arr = arr.filter(r=> r.empresa===emp);

        renderTabelaComissoes(arr);
      }

      function limparFiltroComissao(){
        document.getElementById("comFiltroDataIni").value="";
        document.getElementById("comFiltroDataFim").value="";
        document.getElementById("comFiltroFunc").value="";
        document.getElementById("comFiltroPlaca").value="";
        document.getElementById("comFiltroOrigem").value="";
        document.getElementById("comFiltroSeg").value="";
        document.getElementById("comFiltroEmp").value="";
        renderTabelaComissoes();
      }

      function editarComissao(id){
        console.log("Editar comiss√£o:", id);

        const c = comissoesData.find(x => String(x.id) === String(id));
        if(!c){
          alert("Comiss√£o n√£o encontrada");
          return;
        }

        editingComissaoId = c.id;

        editComData.value = c.data || todayIso();
        editComFuncionario.value = c.funcionario || "";
        editComCategoria.value = c.categoria || "";
        editComKmTotal.value = c.km_total ?? "";
        editComPlaca.value = c.placa || "";
        editComOrigem.value = c.origem || "";
        editComDestino.value = c.destino || "";
        editComSeguradora.value = c.seguradora || "";
        editComEmpresa.value = c.empresa || "";
        editComValor.value = formatMoneyBR(c.valor_total || 0);

        abrirModalEditarComissao();
        aplicarLockModais();
        calcularValorComissao();

      }


      async function salvarEdicaoComissao(){
  if(!editingComissaoId) return;

  const categoria = editComCategoria.value;
  const km_total = Number(editComKmTotal.value || 0);

  // recalcular valor (mesma regra)
  let valor = 0;
  const catLower = categoria.toLowerCase();

  if(catLower === "t√°xi" || catLower === "taxi"){
    valor = km_total * 1.70;
  }
  else if(catLower === "leil√£o" || catLower === "leilao"){
    valor = km_total * 120;
  }
  else{
    const cat = categoriasMem.find(c=>c.categoria===categoria);
    if(cat){
      const kmCalc = Math.max(0, km_total - 40);
      valor = cat.valor_saida + kmCalc * cat.valor_km;
    }
  }

  try{
    const { error } = await supabaseClient
      .from("comissoes")
      .update({
        data: editComData.value,
        funcionario: editComFuncionario.value,
        categoria,
        km_total,
        placa: editComPlaca.value,
        origem: editComOrigem.value.trim(),
        destino: editComDestino.value.trim(),
        seguradora: editComSeguradora.value,
        empresa: editComEmpresa.value,
        valor_total: valor
      })
      .eq("id", editingComissaoId);

    if(error) throw error;

    fecharModalEditarComissao();
    await carregarComissoes();
    alert("Comiss√£o atualizada com sucesso!");
  }
  catch(e){
    console.error(e);
    alert("Erro ao atualizar comiss√£o.");
  }
}



      async function excluirComissao(id){
        if(!currentUser){ alert("Fa√ßa login."); return; }
        if(!confirm("Excluir esta comiss√£o?")) return;
        try{
          const { error } = await supabaseClient.from("comissoes").delete().eq("id",id);
          if(error) throw error;
          alert("Comiss√£o exclu√≠da.");
          await carregarComissoes();
        } catch(e){
          console.error(e);
          alert("Erro ao excluir comiss√£o.");
        }
      }

      async function salvarServicoParticular(){
  if(!currentUser){
      alert("Fa√ßa login para salvar servi√ßos particulares.");
      return;
  }

  const origem = document.getElementById("calcOrigem").value.trim();
  const destino = document.getElementById("calcDestino").value.trim();
  const valor_total = Number((document.getElementById("calcServValorTotal").value || "0").toString().replace(",","."));
  const status = document.getElementById("calcServStatus").value;
  const motorista = document.getElementById("calcServMotorista").value;
  const metodo_pagamento = document.getElementById("calcServMetodo").value;
  const placa_empresa = document.getElementById("calcServPlacaEmp").value;
  const placa_cliente = document.getElementById("calcServPlacaCli").value.trim();
  const data_servico = document.getElementById("calcServData").value;

  if(!origem || !destino || !valor_total || !motorista || !placa_empresa || !data_servico){
      alert("Preencha todos os campos obrigat√≥rios.");
      return;
  }

  try{
      // 1) Inserir servi√ßo particular
      const { data: servData, error: err1 } = await supabaseClient
        .from("servicos_particulares")
        .insert([{
            origem,
            destino,
            valor_total,
            status,
            motorista,
            metodo_pagamento,
            placa_empresa,
            placa_cliente: placa_cliente || null,
            data_servico
        }])
        .select()
        .single();

      if(err1) throw err1;

      // 2) Inserir tamb√©m na tabela de comiss√µes (com os campos solicitados)
      //    km_total = 0, categoria = "Particular", seguradora / empresa = "PARTICULAR"
      const comissaoPayload = {
        data: data_servico,
        funcionario: motorista,
        categoria: "Particular",
        km_total: 0,
        placa: placa_empresa,
        origem,
        destino,
        seguradora: "PARTICULAR",
        empresa: "PARTICULAR",
        valor_total: valor_total,
        servico_particular_id: servData.id // üîó v√≠nculo
      };


      const { error: err2 } = await supabaseClient
        .from("comissoes")
        .insert([comissaoPayload]);

      if(err2) {
        // se falhar na comissao, informamos mas n√£o desfazemos o servi√ßo salvo (cliente j√° tem servi√ßo)
        console.error(err2);
        alert("Servi√ßo salvo, mas houve erro ao inserir comiss√£o: " + (err2.message || err2));
      } else {
        // ok
      }

      alert("Servi√ßo particular salvo com sucesso!");

      // Limpar campos ap√≥s salvar
      document.getElementById("calcServValorTotal").value = "0.00";
      document.getElementById("calcServPlacaCli").value = "";
      document.getElementById("calcServStatus").value = "N√£o pago";
      document.getElementById("calcServMetodo").value = "Dinheiro";

      // Recarregar ambas as tabelas para refletir o novo registro
      await loadServicos();
      await carregarComissoes();
  }
  catch(e){
      console.error(e);
      alert("Erro ao salvar servi√ßo particular.");
  }
}

async function gerarPDFComissoes(){
  if(!currentUser){ alert("Fa√ßa login para gerar o PDF."); return; }

  // Ler filtros atuais (mesma l√≥gica de aplicarFiltroComissao)
  const di = document.getElementById("comFiltroDataIni").value;
  const df = document.getElementById("comFiltroDataFim").value;
  const func = document.getElementById("comFiltroFunc").value;
  const placa = document.getElementById("comFiltroPlaca").value;
  const origemTxt = document.getElementById("comFiltroOrigem").value.trim().toLowerCase();
  const seg = document.getElementById("comFiltroSeg").value;
  const emp = document.getElementById("comFiltroEmp").value;

  let arr = [...comissoesData];
  if(di) arr = arr.filter(r=> r.data >= di);
  if(df) arr = arr.filter(r=> r.data <= df);
  if(func) arr = arr.filter(r=> r.funcionario===func);
  if(placa) arr = arr.filter(r=> r.placa===placa);
  if(origemTxt) arr = arr.filter(r=> (r.origem||"").toLowerCase().includes(origemTxt));
  if(seg) arr = arr.filter(r=> r.seguradora===seg);
  if(emp) arr = arr.filter(r=> r.empresa===emp);

  if(arr.length === 0){
    alert("Nenhum registro encontrado com os filtros aplicados.");
    return;
  }

  // Totais
  const totalGeral = arr.reduce((s,r)=> s + Number(r.valor_total || 0), 0);
  const percentual = 0.06;
  const totalComissao = totalGeral * percentual;

  // Totais por funcion√°rio (obj)
  const porFuncionario = {};
  arr.forEach(r=>{
    const k = r.funcionario || "‚Äî";
    porFuncionario[k] = (porFuncionario[k]||0) + Number(r.valor_total || 0);
  });

  // Totais por empresa
  const porEmpresa = {};
  arr.forEach(r=>{
    const k = r.empresa || "‚Äî";
    porEmpresa[k] = (porEmpresa[k]||0) + Number(r.valor_total || 0);
  });

  // Gerar PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const pageWidth = doc.internal.pageSize.getWidth();

  doc.setFontSize(14);
  doc.text("Relat√≥rio de Comiss√µes (filtrado)", pageWidth/2, 36, { align:"center" });
  doc.setFontSize(10);
  doc.text(`Gerado em: ${new Date().toLocaleString()}`, 40, 56);
  doc.text(`Filtros - Data inicial: ${di||"‚Äî"}  final: ${df||"‚Äî"}  Funcion√°rio: ${func||"Todos"}  Placa: ${placa||"Todas"}`, 40, 72);

  doc.setFontSize(11);
  doc.text(`Total geral (valor bruto): R$ ${formatMoneyBR(totalGeral)}`, 40, 96);
  doc.text(`Total de comiss√£o (6%): R$ ${formatMoneyBR(totalComissao)}`, 40, 112);

  // Tabela principal
  const body = arr.map(r=>[
    r.data || "",
    r.funcionario || "",
    r.categoria || "",
    r.km_total ?? "",
    r.placa || "",
    r.origem || "",
    r.destino || "",
    r.seguradora || "",
    r.empresa || "",
    formatMoneyBR(r.valor_total)
  ]);

  doc.autoTable({
    startY: 140,
    head: [["Data","Funcion√°rio","Categoria","KM","Placa","Origem","Destino","Seguradora","Empresa","Valor (R$)"]],
    body,
    styles: { fontSize: 9 },
    headStyles: { fillColor: [25,103,210] }
  });

  // Espa√ßo ap√≥s tabela
  const afterY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 16 : 400;
  doc.setFontSize(11);
  doc.text("Totais por funcion√°rio:", 40, afterY);
  let y = afterY + 14;
  Object.keys(porFuncionario).forEach(fn=>{
    doc.text(`${fn}: R$ ${formatMoneyBR(porFuncionario[fn])}`, 48, y);
    y += 12;
  });

  y += 8;
  doc.text("Totais por empresa:", 40, y);
  y += 14;
  Object.keys(porEmpresa).forEach(empName=>{
    doc.text(`${empName}: R$ ${formatMoneyBR(porEmpresa[empName])}`, 48, y);
    y += 12;
  });

  // Salvar
  const nomePDF = `Relatorio_Comissoes_${Date.now()}.pdf`;
  doc.save(nomePDF);
}


// ====================== SERVI√áOS PARTICULARES ======================

async function loadServicos(){
  try{
    const { data, error } = await supabaseClient
      .from("servicos_particulares")
      .select("*")
      .order("data_servico", { ascending: false });

    if(error) throw error;

    servicosData = data || [];
    renderTabelaServicos();

    popularFiltrosServicos();
  }
  catch(e){
    console.error(e);
    alert("Erro ao carregar servi√ßos particulares.");
  }
}

function renderTabelaServicos(lista){
  const body = document.getElementById("servicosTabelaBody");
  body.innerHTML = "";

  const arr = lista || servicosData;

  arr.forEach(s => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.data_servico}</td>
      <td>${s.origem}</td>
      <td>${s.destino}</td>
      <td>${s.motorista}</td>
      <td>${s.placa_empresa}</td>
      <td>${s.placa_cliente || ""}</td>
      <td>${s.status}</td>
      <td>${formatMoneyBR(s.valor_total)}</td>
      <td>
        <button class="btn btn-soft btn-sm" data-auth="protected" onclick="editarServico('${s.id}')">üìù</button>
        <button class="btn btn-danger btn-sm" data-auth="protected" onclick="excluirServico('${s.id}')">üóëÔ∏è</button>
      </td>
    `;

    body.appendChild(tr);
  });

  applyAuthProtection();
 

}

function popularFiltrosServicos(){
  // Motoristas
  const motSel = document.getElementById("servFiltroMotorista");
  motSel.innerHTML = `<option value="">Todos</option>`;
  getMotoristasAtivos().forEach(n => {
  motSel.innerHTML += `<option>${n}</option>`;
});


  // Placas empresa
  const placaSel = document.getElementById("servFiltroPlacaEmp");
  placaSel.innerHTML = `<option value="">Todas</option>`;
  PLACAS_FIXAS.forEach(p => {
    placaSel.innerHTML += `<option>${p}</option>`;
  });
}

function aplicarFiltroServicos(){
  const di = document.getElementById("servFiltroDataIni").value;
  const df = document.getElementById("servFiltroDataFim").value;
  const placaEmp = document.getElementById("servFiltroPlacaEmp").value;
  const placaCli = document.getElementById("servFiltroPlacaCli").value.trim().toLowerCase();
  const mot = document.getElementById("servFiltroMotorista").value;

  let lista = [...servicosData];

  if(di) lista = lista.filter(s => s.data_servico >= di);
  if(df) lista = lista.filter(s => s.data_servico <= df);
  if(placaEmp) lista = lista.filter(s => s.placa_empresa === placaEmp);
  if(placaCli) lista = lista.filter(s => (s.placa_cliente || "").toLowerCase().includes(placaCli));
  if(mot) lista = lista.filter(s => s.motorista === mot);

  renderTabelaServicos(lista);
}

function limparFiltroServicos(){
  document.getElementById("servFiltroDataIni").value = "";
  document.getElementById("servFiltroDataFim").value = "";
  document.getElementById("servFiltroPlacaEmp").value = "";
  document.getElementById("servFiltroPlacaCli").value = "";
  document.getElementById("servFiltroMotorista").value = "";

  renderTabelaServicos();
}



async function excluirServico(id){
  if(!currentUser){ alert("Fa√ßa login."); return; }
  if(!confirm("Deseja excluir este servi√ßo?")) return;

  try{
    // 1Ô∏è‚É£ Excluir comiss√£o vinculada
    await supabaseClient
      .from("comissoes")
      .delete()
      .eq("servico_particular_id", id);

    // 2Ô∏è‚É£ Excluir servi√ßo particular
    const { error } = await supabaseClient
      .from("servicos_particulares")
      .delete()
      .eq("id", id);

    if(error) throw error;

    alert("Servi√ßo exclu√≠do.");
    await loadServicos();
    await carregarComissoes();
  }
  catch(e){
    console.error(e);
    alert("Erro ao excluir servi√ßo.");
  }
}


// ============================================================
// =================== EDI√á√ÉO DE SERVI√áOS ======================
// ============================================================

function abrirModalEditarServico(){
  const backdrop = document.getElementById("modalEditarServicoBackdrop");
  if(!backdrop){
    console.error("Backdrop do modal n√£o encontrado");
    return;
  }
  backdrop.classList.add("active");
}

function fecharModalEditarServico(){
  const backdrop = document.getElementById("modalEditarServicoBackdrop");
  if(backdrop){
    backdrop.classList.remove("active");
  }
  editingServicoId = null;
}

function editarServico(id){
  console.log("Editar servi√ßo ID:", id);
  console.log("Servi√ßos carregados:", servicosData);

  const s = servicosData.find(x => String(x.id) === String(id));

  if(!s){
    alert("Servi√ßo n√£o encontrado");
    return;
  }

  editingServicoId = s.id;

  editServOrigem.value = s.origem || "";
  editServDestino.value = s.destino || "";
  editServMotorista.value = s.motorista || "";
  editServStatus.value = s.status || "N√£o pago";
  editServPlacaEmp.value = s.placa_empresa || "";
  editServPlacaCli.value = s.placa_cliente || "";
  editServValor.value = s.valor_total || 0;
  editServData.value = s.data_servico || "";

  abrirModalEditarServico();
  aplicarLockModais();
}




async function salvarEdicaoServico(){
  if(!editingServicoId) return;

  const updateData = {
    origem: document.getElementById("editServOrigem").value.trim(),
    destino: document.getElementById("editServDestino").value.trim(),
    motorista: document.getElementById("editServMotorista").value,
    status: document.getElementById("editServStatus").value,
    placa_empresa: document.getElementById("editServPlacaEmp").value,
    placa_cliente: document.getElementById("editServPlacaCli").value.trim() || null,
    valor_total: Number(document.getElementById("editServValor").value),
    data_servico: document.getElementById("editServData").value
  };

  try {
    const { error } = await supabaseClient
      .from("servicos_particulares")
      .update(updateData)
      .eq("id", editingServicoId);

    if(error) throw error;

    // Atualizar comiss√£o vinculada
await supabaseClient
  .from("comissoes")
  .update({
    data: updateData.data_servico,
    funcionario: updateData.motorista,
    placa: updateData.placa_empresa,
    origem: updateData.origem,
    destino: updateData.destino,
    valor_total: updateData.valor_total
  })
  .eq("servico_particular_id", editingServicoId);

   fecharModalEditarServico();

// üîÑ recarrega servi√ßos E comiss√µes
await loadServicos();
await carregarComissoes();

alert("Servi√ßo atualizado com sucesso!");

  }
  catch(e){
    console.error(e);
    alert("Erro ao salvar altera√ß√µes.");
  }
}




function popularEdicaoServicos(){
  // Motoristas
  const motSel = document.getElementById("editServMotorista");
  motSel.innerHTML = "";
  getMotoristasAtivos().forEach(n => {
  motSel.innerHTML += `<option>${n}</option>`;
});


  // Placas empresa
  const placaSel = document.getElementById("editServPlacaEmp");
  placaSel.innerHTML = "";
  PLACAS_FIXAS.forEach(p => {
    placaSel.innerHTML += `<option>${p}</option>`;
  });
}

function abrirModalEditarComissao(){
  const backdrop = document.getElementById("modalEditarComissaoBackdrop");
  if(backdrop) backdrop.classList.add("active");
}

function fecharModalEditarComissao(){
  const backdrop = document.getElementById("modalEditarComissaoBackdrop");
  if(backdrop) backdrop.classList.remove("active");
  editingComissaoId = null;
}

function popularEdicaoComissao(){
  // Funcion√°rios
  const funcSel = document.getElementById("editComFuncionario");
  funcSel.innerHTML = "";
  getMotoristasAtivos().forEach(n=>{
    funcSel.innerHTML += `<option>${n}</option>`;
  });

  // Categorias
  const catSel = document.getElementById("editComCategoria");
  catSel.innerHTML = "";
  categoriasMem.forEach(c=>{
    catSel.innerHTML += `<option>${c.categoria}</option>`;
  });

  // Placas
  const placaSel = document.getElementById("editComPlaca");
  placaSel.innerHTML = "";
  PLACAS_FIXAS.forEach(p=>{
    placaSel.innerHTML += `<option>${p}</option>`;
  });

  // Seguradoras
  const segSel = document.getElementById("editComSeguradora");
  segSel.innerHTML = "";
  SEGURADORAS_FIXAS.forEach(s=>{
    segSel.innerHTML += `<option>${s}</option>`;
  });

  // Empresas
  const empSel = document.getElementById("editComEmpresa");
  empSel.innerHTML = "";
  EMPRESAS_FIXAS.forEach(e=>{
    empSel.innerHTML += `<option>${e}</option>`;
  });
}



async function gerarPDFServicos(){
  if(!currentUser){
    alert("Fa√ßa login para gerar o PDF.");
    return;
  }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  const lista = servicosData;

  doc.setFontSize(16);
  doc.text("Relat√≥rio de Servi√ßos Particulares", 14, 18);

  doc.setFontSize(10);
  doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 26);

  const total = lista.reduce((sum, s) => sum + Number(s.valor_total), 0);

  doc.text(`Total geral: R$ ${total.toFixed(2)}`, 14, 34);

  const tabela = lista.map(s => [
    s.data_servico,
    s.origem,
    s.destino,
    s.motorista,
    s.placa_empresa,
    s.placa_cliente || "",
    s.status,
    "R$ " + s.valor_total.toFixed(2)
  ]);

  doc.autoTable({
    head: [[
      "Data",
      "Origem",
      "Destino",
      "Motorista",
      "Placa Emp.",
      "Placa Cli.",
      "Status",
      "Valor"
    ]],
    body: tabela,
    startY: 40,
    theme: "striped",
    headStyles: { fillColor: [0, 122, 255] }
  });

  doc.save("servicos_particulares.pdf");
}




      // ========== INIT ==========
      async function initApp(){
        // Escala
        gerarMesesEscala();
        popularFuncionariosEscala();
        document.getElementById("escalaFuncSelect").addEventListener("change", montarListaEscala);
        document.getElementById("escalaMesSelect").addEventListener("change", montarListaEscala);
        montarListaEscala();
        await carregarFolgasDoBanco();

        // Motoristas/Placas (para abastecimentos)
        await loadMotoristasPlacas();

        //Servi√ßos particulares
        await loadServicos();
        popularEdicaoServicos();


        // Abastecimento defaults
        document.getElementById("abastData").value = todayIso();
        await loadAbastecimentos();

        // Categorias, calculadora, comiss√£o combos
        await carregarCategorias();

        // Comiss√£o
        await carregarComissoes();
        popularEdicaoComissao();


        applyAuthProtection();
      }

      restoreSession().then(initApp);

      document.addEventListener("DOMContentLoaded", () => {
  const btnLoginTop = document.getElementById("btnLoginTop");

  if (btnLoginTop) {
    btnLoginTop.addEventListener("click", () => {
      openLoginModal();
    });
  }
});


      async function editarMotorista(id){
  if(!currentUser){
    alert("Fa√ßa login para editar.");
    return;
  }

  const input = document.getElementById("editMot_" + id);
  const novoNome = input.value.trim();

  if(!novoNome){
    alert("O nome n√£o pode ficar vazio.");
    return;
  }

  const { error } = await supabaseClient
    .from("motoristas")
    .update({ nome: novoNome })
    .eq("id", id);

  if(error){
    console.error(error);
    alert("Erro ao renomear motorista.");
    return;
  }

  await refreshMotoristasPlacas();
  alert("Motorista atualizado com sucesso!");
}

    </script>



  </body>
  </html>
