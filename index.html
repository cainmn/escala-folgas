<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Escala de Folgas</title>

<!-- jsPDF + autoTable (para gerar PDF no cliente) -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<style>
  :root{
    --bg:#eef1f5; --card:#fff; --text:#222; --muted:#666;
    --accent:#007bff; --ok:#4caf50; --warn:#ffeb8a; --danger:#ffd2d2;
    --warn-border:#f0d24c; --danger-border:#aa1f1f;
  }
  .dark{
    --bg:#121212; --card:#1b1b1b; --text:#e6e6e6; --muted:#aaa; --accent:#5aa9ff;
    --warn:#f4f7c4; --danger:#ffd2d2;
  }
  body { font-family: Arial, sans-serif; background:var(--bg); color:var(--text); margin:0; padding:20px; }
  h2 { text-align:center; margin-bottom:12px; }
  .controls { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
  select, button { padding:10px; font-size:14px; border-radius:8px; border:1px solid #bbb; cursor:pointer; background:var(--card); color:var(--text); }
  button.primary { background:var(--accent); color:white; border:none; }
  button.green { background:var(--ok); color:white; border:none; }
  button.orange { background:var(--warn); color:black; border:none; }
  button.red { background:var(--danger); color:black; border:none; }
  .pessoa { background:var(--card); padding:14px; margin-bottom:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
  /* highlight areas: ensure text remains leg√≠vel in dark mode by forcing black text on warn/danger backgrounds */
  .em-folga { background:var(--danger) !important; border-left:6px solid var(--danger-border); color:black; }
  .em-folga * { color:black !important; }
  .entra-hoje { background:var(--warn) !important; border-left:6px solid var(--warn-border); color:black; }
  .entra-hoje * { color:black !important; }
  .titulo { font-size:18px; font-weight:700; margin-bottom:8px; }
  .folga-item { padding:6px 0; }
  .data { font-weight:700; color:var(--text); }
  .hora { color:var(--muted); }
  hr { border:none; border-bottom:1px solid rgba(0,0,0,0.08); margin:8px 0; }

  /* login modal */
  .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.4); z-index:9999; }
  .card { background:var(--card); padding:18px; border-radius:12px; width:320px; box-shadow:0 8px 30px rgba(0,0,0,0.3); color:var(--text); }
  input[type="email"], input[type="password"], input[type="text"]{ width:100%; padding:8px; margin:6px 0 12px; border-radius:6px; border:1px solid #ccc; background:transparent; color:var(--text); }

  /* floating menu (hamburger popup) */
  .hamburger {
    position:fixed; left:12px; top:16px; z-index:1000;
    width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center;
    background:var(--card); box-shadow:0 6px 18px rgba(0,0,0,0.12); cursor:pointer; border:1px solid #ccc;
  }
  .hamburger:hover{ transform:translateY(-2px); transition:0.12s; }

  .menuPopup {
    position:fixed; left:12px; top:70px; z-index:1000; width:300px; border-radius:10px;
    background:var(--card); box-shadow:0 10px 30px rgba(0,0,0,0.18); padding:12px; display:none;
  }
  .menuPopup .row{ display:flex; gap:8px; align-items:center; margin-bottom:8px; }
  .menuPopup label{ font-size:13px; color:var(--muted); }
  .menuPopup .spaced{ display:flex; justify-content:space-between; align-items:center; gap:8px; }

  /* small helpers */
  .small { font-size:13px; color:var(--muted); }
  .hidden { display:none !important; }

  /* responsive */
  @media(max-width:560px){
    .menuPopup { width:92%; left:4%; top:68px; }
  }
</style>
</head>
<body>

<!-- hamburger button -->
<div class="hamburger" id="hamburgerBtn" title="Menu ‚ò∞">‚ò∞</div>

<!-- menu popup -->
<div class="menuPopup" id="menuPopup" aria-hidden="true">
  <div class="row spaced">
    <div>
      <div id="menuUser" style="font-weight:700">N√£o conectado</div>
      <div class="small" id="menuUserEmail"></div>
    </div>
    <div>
      <button id="menuLoginBtn" class="primary small">Login</button>
      <button id="menuLogoutBtn" class="small hidden">Logout</button>
    </div>
  </div>

  <hr>

  <div class="row">
    <button class="small" onclick="carregarFolgasDoBanco()">Carregar da Nuvem</button>
    <button class="small" onclick="salvarTodasNoBanco()">Salvar na Nuvem</button>
  </div>

  <div style="height:8px"></div>

  <div class="row">
    <label><input type="checkbox" id="darkToggleMenu"> Modo escuro</label>
  </div>

  <div style="height:6px"></div>

  <div class="row">
    <label style="width:100%">Funcion√°rio</label>
    <select id="funcSelectMenu" style="width:100%"></select>
  </div>

  <div class="row">
    <label style="width:100%">M√™s / Ano</label>
    <select id="mesSelectMenu" style="width:100%"></select>
  </div>

  <div style="height:8px"></div>

  <div class="row">
    <button class="primary" id="gerarPdfBtn">Gerar PDF (func./m√™s)</button>
  </div>

  <div style="height:8px"></div>

  <div class="small">Obs: notifica√ß√µes 12h s√≥ funcionam enquanto a aba estiver aberta.</div>
</div>

<!-- login modal -->
<div id="loginModal" class="modal" style="display:none;">
  <div class="card">
    <h3>Entrar</h3>
    <div class="small">Use o usu√°rio do Supabase (email e senha).</div>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPass" type="password" placeholder="Senha" />
    <label><input id="rememberMe" type="checkbox" /> Lembrar de mim</label>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button class="primary" onclick="doLogin()">Entrar</button>
      <button onclick="closeLogin()">Fechar</button>
    </div>
    <div id="loginMsg" class="small" style="margin-top:8px;color:crimson;"></div>
  </div>
</div>

<h2>Escala de Folgas</h2>

<div class="controls">
    <select id="funcSelect"><option value="todos">Todos Funcion√°rios</option></select>

    <select id="mesSelect">
        <option value="todos">Todos os meses</option>
    </select>

    <button class="primary" onclick="mostrarFolgasAgora()">Quem est√° de folga agora?</button>
    <button class="small" onclick="scheduleLocalReminders()">Agendar notifica√ß√µes (local)</button>
</div>

<div id="lista"></div>

<script>
/* -------------- CONFIG SUPABASE -------------- */
const SUPABASE_URL = "https://gaqazvekgpvecuhfuiel.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhcWF6dmVrZ3B2ZWN1aGZ1aWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MDc1NDQsImV4cCI6MjA4MDQ4MzU0NH0.crmOSloZVI0CMuJkIBLfOI6yKiT8dmEa10xrQnFBIcM";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* -------------- HELPERS -------------- */
function pad2(n){ return n.toString().padStart(2,"0"); }
function parseDateTime(str){
  if(!str) return new Date(0);
  if(str.includes("T") || str.includes("Z")){
    const d = new Date(str);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), d.getMinutes());
  }
  const [d,t] = String(str).split(" ");
  const [Y,M,D] = d.split("-").map(Number);
  const [h,m] = (t||"00:00").split(":").map(Number);
  return new Date(Y, M-1, D, h, m);
}
function formatDateTime(dt){ return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`; }
function formatDateInput(dt){ return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`; }
function formatTimeInput(dt){ return `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`; }

/* -------------- DADOS INICIAIS (fallback) -------------- */
const folgas = [
  { nome:"Anderson Saraiva Serrano", editando:false, periodos:[
    ["2025-12-02 07:00","2025-12-03 19:00"],
    ["2025-12-10 19:00","2025-12-12 07:00"],
    ["2025-12-19 07:00","2025-12-20 19:00"],
    ["2025-12-27 19:00","2025-12-29 07:00"],
    ["2025-12-30 07:00","2025-12-31 19:00"]
  ]},
  { nome:"Henrique", editando:false, periodos:[
    ["2025-12-03 19:00","2025-12-05 07:00"],
    ["2025-12-12 07:00","2025-12-13 19:00"],
    ["2025-12-20 19:00","2025-12-22 07:00"],
    ["2025-12-23 07:00","2025-12-24 19:00"],
    ["2025-12-31 19:00","2026-01-02 07:00"]
  ]},
  { nome:"Jo√£o", editando:false, periodos:[
    ["2025-12-05 07:00","2025-12-06 19:00"],
    ["2025-12-13 19:00","2025-12-15 07:00"],
    ["2025-12-16 07:00","2025-12-17 19:00"],
    ["2025-12-24 19:00","2025-12-26 07:00"]
  ]},
  { nome:"Rafael", editando:false, periodos:[
    ["2025-12-06 19:00","2025-12-08 07:00"],
    ["2025-12-09 07:00","2025-12-10 19:00"],
    ["2025-12-17 19:00","2025-12-19 07:00"],
    ["2025-12-26 07:00","2025-12-27 19:00"]
  ]},
  { nome:"Vanderlei", editando:false, periodos:[]}
];
folgas[5] && (folgas[5].periodos = folgas[3].periodos ? JSON.parse(JSON.stringify(folgas[3].periodos)) : []);

/* -------------- POPULAR SELECTS -------------- */
function popularFuncionariosTo(selId){
  const sel = document.getElementById(selId);
  sel.innerHTML = '<option value="todos">Todos Funcion√°rios</option>';
  folgas.forEach(f => {
    const o = document.createElement("option"); o.value = f.nome; o.textContent = f.nome; sel.appendChild(o);
  });
}
function gerarMesesNoSelects(){
  const selMain = document.getElementById("mesSelect");
  const selMenu = document.getElementById("mesSelectMenu");
  selMain.innerHTML = '<option value="todos">Todos os meses</option>';
  selMenu.innerHTML = '<option value="todos">Todos os meses</option>';
  const hoje = new Date();
  const primeiroAno = 2025, primeiroMes = 12; // n√£o mostrar meses ANTES de 2025-12
  const start = new Date(Math.max(new Date(primeiroAno, primeiroMes-1,1).getTime(), new Date(hoje.getFullYear(), hoje.getMonth(),1).getTime()));
  const anoStart = start.getFullYear(), mesStart = start.getMonth()+1;
  for(let ano=anoStart; ano<=2026; ano++){
    for(let mes = (ano===anoStart?mesStart:1); mes<=12; mes++){
      const v = `${ano}-${pad2(mes)}`;
      const nome = new Date(ano, mes-1,1).toLocaleDateString("pt-BR",{month:"long"});
      const o1 = document.createElement("option"); o1.value = v; o1.textContent = `${nome} ${ano}`; selMain.appendChild(o1);
      const o2 = document.createElement("option"); o2.value = v; o2.textContent = `${nome} ${ano}`; selMenu.appendChild(o2);
    }
  }
  // selecionar m√™s atual ou 2025-12 (m√≠nimo)
  const atual = `${(new Date()).getFullYear()}-${pad2((new Date()).getMonth()+1)}`;
  const min = `2025-12`;
  const selVal = (atual < min ? min : atual);
  selMain.value = selVal; selMenu.value = selVal;
}

/* -------------- REGRAS E GERA√á√ÉO (fallback) -------------- */
function gerarFolgasAte2026(){
  const limite = new Date(2026,11,31,23,59);
  folgas.forEach(pessoa => {
    if(!pessoa.periodos || pessoa.periodos.length===0) return;
    let ultFim = parseDateTime(pessoa.periodos[pessoa.periodos.length-1][1]);
    while(true){
      let inicio;
      if(ultFim.getDay() === 1){
        inicio = new Date(ultFim); inicio.setDate(inicio.getDate()+1); inicio.setHours(7,0,0,0);
      } else {
        inicio = new Date(ultFim.getTime() + 7*24*60*60*1000);
        if(inicio.getDay() === 1){ inicio.setDate(inicio.getDate()+1); inicio.setHours(7,0,0,0); }
      }
      if(inicio > limite) break;
      const fim = new Date(inicio.getTime() + 36*60*60*1000);
      pessoa.periodos.push([ formatDateTime(inicio), formatDateTime(fim) ]);
      ultFim = fim;
    }
  });
  // sincronizar Rafael/Vanderlei
  const r = folgas.find(x=>x.nome==="Rafael"), v = folgas.find(x=>x.nome==="Vanderlei");
  if(r && v) v.periodos = JSON.parse(JSON.stringify(r.periodos));
}

/* -------------- ESTA DE FOLGA -------------- */
function estaDeFolga(periodos){
  const agora = new Date();
  return periodos.some(([ini,fim]) => {
    const a = parseDateTime(ini), b = parseDateTime(fim);
    return agora >= a && agora <= b;
  });
}

/* -------------- MONTAR LISTA -------------- */
function montarLista(){
  const filtroFunc = document.getElementById("funcSelect").value;
  const filtroMes = document.getElementById("mesSelect").value;
  const lista = document.getElementById("lista"); lista.innerHTML = "";

  folgas.forEach(pessoa => {
    if(filtroFunc !== "todos" && pessoa.nome !== filtroFunc) return;

    // filtra apenas per√≠odos do m√™s selecionado
    const mostrar = pessoa.periodos.filter(p => filtroMes === "todos" || p[0].startsWith(filtroMes));
    if(mostrar.length === 0) return;

    const div = document.createElement("div"); div.classList.add("pessoa");
    if(estaDeFolga(pessoa.periodos)) div.classList.add("em-folga");
    // destacar quem entra hoje √† noite (ex: inicia no dia atual com hora >= 18)
    const hoje = new Date();
    const prefixHoje = `${hoje.getFullYear()}-${pad2(hoje.getMonth()+1)}-${pad2(hoje.getDate())}`;
    if(mostrar.some(p => p[0].startsWith(prefixHoje) && parseDateTime(p[0]).getHours() >= 18)) div.classList.add("entra-hoje");

    if(pessoa.editando){
      const nomeID = pessoa.nome.replace(/\s+/g,"_");
      div.innerHTML = `<div class="titulo">${pessoa.nome}</div>` +
        mostrar.map((p,i)=> {
          const ini = parseDateTime(p[0]), fim = parseDateTime(p[1]);
          return `<div style="background:#eee;padding:10px;margin-bottom:10px;border-radius:8px;">
            <b>Per√≠odo ${i+1}</b><br><br>
            In√≠cio:<br>
            <input type="date" id="iniData_${nomeID}_${i}" value="${formatDateInput(ini)}"><br>
            <input type="time" id="iniHora_${nomeID}_${i}" value="${formatTimeInput(ini)}"><br><br>
            Fim:<br>
            <input type="date" id="fimData_${nomeID}_${i}" value="${formatDateInput(fim)}"><br>
            <input type="time" id="fimHora_${nomeID}_${i}" value="${formatTimeInput(fim)}"><br><br>
            <button class="red" onclick="removerFolgaFiltrada('${pessoa.nome}',${i})">üóë Remover</button>
          </div>`;
        }).join("") +
        `<button class="primary" onclick="adicionarFolga('${pessoa.nome}')">‚ûï Adicionar</button>
         <button class="green" onclick="salvarEdicao('${pessoa.nome}')">Salvar</button>
         <button class="red" onclick="cancelarEdicao('${pessoa.nome}')">Cancelar</button>`;
    } else {
      div.innerHTML = `<div class="titulo">${pessoa.nome}</div>
        <button class="green" onclick="copiarFolgas('${pessoa.nome}')">üìã Copiar</button>
        <button class="orange" onclick="editar('${pessoa.nome}')">‚úè Editar</button>` +
        mostrar.map((p,i)=> {
          const ini = parseDateTime(p[0]), fim = parseDateTime(p[1]);
          return `<div class="folga-item">
            <div class="data">üóì ${ini.toLocaleDateString("pt-BR")} ‚Üí ${fim.toLocaleDateString("pt-BR")}</div>
            <div class="hora">‚è∞ Das ${ini.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})} √†s ${fim.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})}</div>
          </div>${i<mostrar.length-1?'<hr>':''}`;
        }).join("");
    }

    lista.appendChild(div);
  });
}

/* -------------- EDI√á√ÉO -------------- */
function editar(nome){ folgas.find(f=>f.nome===nome).editando = true; montarLista(); }
function cancelarEdicao(nome){ folgas.find(f=>f.nome===nome).editando = false; montarLista(); }
function removerFolgaFiltrada(nome, idxFiltrado){
  const filtroMes = document.getElementById("mesSelect").value;
  const pessoa = folgas.find(f=>f.nome===nome);
  const filtrados = pessoa.periodos.filter(p=> p[0].startsWith(filtroMes));
  const periodo = filtrados[idxFiltrado];
  pessoa.periodos = pessoa.periodos.filter(p => !(p[0] === periodo[0] && p[1] === periodo[1]));
  // manter Rafael/Vanderlei sincronizados
  const r = folgas.find(x=>x.nome==="Rafael"), v = folgas.find(x=>x.nome==="Vanderlei");
  if(r && v) v.periodos = JSON.parse(JSON.stringify(r.periodos));
  montarLista();
}
function adicionarFolga(nome){
  const pessoa = folgas.find(f=>f.nome===nome);
  const lastEnd = parseDateTime(pessoa.periodos[pessoa.periodos.length-1][1]);
  let inicio;
  if(lastEnd.getDay()===1){ inicio = new Date(lastEnd); inicio.setDate(inicio.getDate()+1); inicio.setHours(7,0,0,0); }
  else { inicio = new Date(lastEnd.getTime() + 7*24*60*60*1000); if(inicio.getDay()===1){ inicio.setDate(inicio.getDate()+1); inicio.setHours(7,0,0,0); } }
  const fim = new Date(inicio.getTime() + 36*60*60*1000);
  pessoa.periodos.push([ formatDateTime(inicio), formatDateTime(fim) ]);
  const r = folgas.find(x=>x.nome==="Rafael"), v = folgas.find(x=>x.nome==="Vanderlei");
  if(r && v) v.periodos = JSON.parse(JSON.stringify(r.periodos));
  montarLista();
}
async function salvarEdicao(nome){
  const pessoa = folgas.find(f=>f.nome===nome);
  const nomeID = nome.replace(/\s+/g,"_");
  const filtroMes = document.getElementById("mesSelect").value;
  // coletar editados (√≠ndices locais)
  const filtrados = pessoa.periodos.filter(p => filtroMes === "todos" || p[0].startsWith(filtroMes));
  const novosFiltrados = [];
  for(let i=0;i<filtrados.length;i++){
    const di = document.getElementById(`iniData_${nomeID}_${i}`).value;
    const hi = document.getElementById(`iniHora_${nomeID}_${i}`).value;
    const df = document.getElementById(`fimData_${nomeID}_${i}`).value;
    const hf = document.getElementById(`fimHora_${nomeID}_${i}`).value;
    if(!di||!hi||!df||!hf){ alert("Preencha todos os campos."); return; }
    novosFiltrados.push([ `${di} ${hi}`, `${df} ${hf}` ]);
  }
  // reconstruir lista completa mantendo per√≠odos de outros meses
  const novos = [];
  pessoa.periodos.forEach(p => { if(!p[0].startsWith(filtroMes)) novos.push(p); });
  novos.push(...novosFiltrados);
  pessoa.periodos = novos.sort((a,b)=> parseDateTime(a[0]) - parseDateTime(b[0]));
  pessoa.editando = false;
  // manter Rafael/Vanderlei
  const r = folgas.find(x=>x.nome==="Rafael"), v = folgas.find(x=>x.nome==="Vanderlei");
  if(r && v) v.periodos = JSON.parse(JSON.stringify(r.periodos));
  montarLista();
  await salvarTodasNoBanco();
}

/* -------------- SUPABASE: CARREGAR / SALVAR -------------- */
async function carregarFolgasDoBanco(){
  try {
    const { data, error } = await supabaseClient.from('folgas').select('*').order('inicio',{ascending:true});
    if(error){ console.error(error); alert("Erro ao carregar da nuvem."); return false; }
    if(!data || data.length===0) return false;
    // reset local
    folgas.forEach(f=> f.periodos = []);
    data.forEach(row=>{
      const pessoa = folgas.find(p=>p.nome===row.funcionario);
      if(pessoa) pessoa.periodos.push([ row.inicio, row.fim ]);
      else folgas.push({ nome: row.funcionario, editando:false, periodos:[[row.inicio,row.fim]] });
    });
    // garantir Rafael/Vanderlei
    const r = folgas.find(x=>x.nome==="Rafael"), v = folgas.find(x=>x.nome==="Vanderlei");
    if(r && v) v.periodos = JSON.parse(JSON.stringify(r.periodos));
    // ordenar per√≠odos
    folgas.forEach(f=> f.periodos.sort((a,b)=> parseDateTime(a[0]) - parseDateTime(b[0])));
    popularFuncionariosTo('funcSelect');
    popularFuncionariosTo('funcSelectMenu');
    gerarMesesNoSelects();
    montarLista();
    return true;
  } catch(e){ console.error(e); alert("Erro ao carregar do Supabase."); return false; }
}

async function salvarTodasNoBanco(){
  try {
    await supabaseClient.from('folgas').delete().neq('id',0);
    const linhas = [];
    folgas.forEach(f=> {
      f.periodos.forEach(p=> linhas.push({ funcionario: f.nome, inicio: p[0], fim: p[1] }));
    });
    if(linhas.length){
      const { error } = await supabaseClient.from('folgas').insert(linhas);
      if(error){ console.error(error); alert("Erro ao salvar no banco."); return; }
    }
    alert("Salvo na nuvem!");
  } catch(e){ console.error(e); alert("Erro ao salvar na nuvem."); }
}

/* -------------- LOGIN / SESS√ÉO -------------- */
const loginModal = document.getElementById("loginModal");
const menuPopup = document.getElementById("menuPopup");
const menuUser = document.getElementById("menuUser");
const menuUserEmail = document.getElementById("menuUserEmail");
const menuLoginBtn = document.getElementById("menuLoginBtn");
const menuLogoutBtn = document.getElementById("menuLogoutBtn");

menuLoginBtn.addEventListener("click", ()=> openLogin());
menuLogoutBtn.addEventListener("click", async ()=>{
  await supabaseClient.auth.signOut();
  localStorage.removeItem("rememberMe");
  menuUser.textContent = "N√£o conectado"; menuUserEmail.textContent = "";
  menuLogoutBtn.classList.add("hidden"); menuLoginBtn.classList.remove("hidden");
  alert("Deslogado");
});

function openLogin(){ document.getElementById("loginMsg").textContent=""; loginModal.style.display="flex"; }
function closeLogin(){ loginModal.style.display="none"; }

async function doLogin(){
  const email = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPass").value;
  const remember = document.getElementById("rememberMe").checked;
  if(!email || !pass){ document.getElementById("loginMsg").textContent="Preencha email e senha."; return; }
  document.getElementById("loginMsg").textContent = "Entrando...";
  const res = await supabaseClient.auth.signInWithPassword({ email, password: pass });
  if(res.error){ document.getElementById("loginMsg").textContent = res.error.message; return; }
  // login ok
  if(remember) localStorage.setItem("rememberMe","1");
  loginModal.style.display="none";
  menuUser.textContent = (res.data.user.user_metadata && res.data.user.user_metadata.full_name) ? res.data.user.user_metadata.full_name : res.data.user.email;
  menuUserEmail.textContent = res.data.user.email;
  menuLoginBtn.classList.add("hidden"); menuLogoutBtn.classList.remove("hidden");
  alert("Logado com sucesso!");
}

// restore session
(async function restoreSession(){
  const s = await supabaseClient.auth.getSession();
  if(s && s.data && s.data.session){
    const user = s.data.session.user;
    menuUser.textContent = (user.user_metadata && user.user_metadata.full_name) ? user.user_metadata.full_name : user.email;
    menuUserEmail.textContent = user.email;
    menuLoginBtn.classList.add("hidden"); menuLogoutBtn.classList.remove("hidden");
  }
})();

/* -------------- MODO ESCURO -------------- */
const darkToggle = document.getElementById("darkToggleMenu");
darkToggle.addEventListener("change", ()=> {
  if(darkToggle.checked){ document.documentElement.classList.add("dark"); localStorage.setItem("dark","1"); }
  else { document.documentElement.classList.remove("dark"); localStorage.removeItem("dark"); }
});
if(localStorage.getItem("dark")){ darkToggle.checked=true; document.documentElement.classList.add("dark"); }

/* -------------- NOTIFICA√á√ïES LOCAIS -------------- */
async function requestNotificationPermission(){ 
  if(!("Notification" in window)) return false;
  if(Notification.permission === "granted") return true;
  if(Notification.permission !== "denied"){
    const p = await Notification.requestPermission();
    return p === "granted";
  }
  return false;
}
async function scheduleLocalReminders(){
  if(!await requestNotificationPermission()) { alert("Permiss√£o de notifica√ß√µes negada."); return; }
  const now = new Date();
  folgas.forEach(p=>{
    p.periodos.forEach(pr=>{
      const ini = parseDateTime(pr[0]);
      const fim = parseDateTime(pr[1]);
      const antesIni = new Date(ini.getTime() - 12*60*60*1000);
      if(antesIni > now){
        setTimeout(()=> new Notification(`${p.nome} entra em folga`, { body: `Come√ßa em ${ini.toLocaleString("pt-BR")}` }), antesIni - now);
      }
      const antesFim = new Date(fim.getTime() - 12*60*60*1000);
      if(antesFim > now){
        setTimeout(()=> new Notification(`${p.nome} volta da folga`, { body: `Volta em ${fim.toLocaleString("pt-BR")}` }), antesFim - now);
      }
    });
  });
  alert("Lembretes locais agendados (quando a aba estiver aberta).");
}

/* -------------- COPIAR / QUEM EST√Å -------------- */
function copiarFolgas(nome){
  const f = folgas.find(x=>x.nome===nome);
  const filtroMes = document.getElementById("mesSelect").value;
  let lista = f.periodos;
  if(filtroMes !== "todos") lista = lista.filter(p=>p[0].startsWith(filtroMes));
  if(lista.length===0){ alert("Sem folgas no m√™s selecionado."); return; }
  let ref = lista[0][0].slice(5,7)+"/"+lista[0][0].slice(0,4);
  let texto = `Ol√° ${f.nome}! Aqui est√° sua escala de folgas para ${ref}:\n\n` + lista.map(p=>`- ${p[0]} at√© ${p[1]}`).join("\n");
  navigator.clipboard.writeText(texto).then(()=>alert("Copiado!")).catch(()=>alert("N√£o foi poss√≠vel copiar automaticamente."));
}
function mostrarFolgasAgora(){
  const em = folgas.filter(f=>estaDeFolga(f.periodos));
  if(em.length===0) alert("Ningu√©m est√° de folga agora.");
  else alert("Em folga:\n" + em.map(x=>x.nome).join("\n"));
}

/* -------------- GERAR PDF (jsPDF + autoTable) -------------- */
async function gerarPDFFuncionarioMes(){
  const func = document.getElementById("funcSelectMenu").value;
  const mes = document.getElementById("mesSelectMenu").value;
  if(func === "todos"){ alert("Escolha um funcion√°rio no menu."); return; }
  if(!mes || mes === "todos"){ alert("Escolha um m√™s/ano no menu."); return; }
  const pessoa = folgas.find(f=>f.nome === func);
  if(!pessoa){ alert("Funcion√°rio n√£o encontrado."); return; }
  const rows = pessoa.periodos.filter(p=> p[0].startsWith(mes));
  if(rows.length === 0){ alert("Sem folgas desse funcion√°rio no m√™s selecionado."); return; }

  // montar PDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const pageWidth = doc.internal.pageSize.getWidth();

  // header
  doc.setFontSize(14);
  doc.text("Escala de Folgas", pageWidth/2, 40, { align: "center" });
  doc.setFontSize(11);
  doc.text(`Funcion√°rio: ${pessoa.nome}`, 40, 70);
  doc.text(`M√™s/Ano: ${mes.slice(5,7)}/${mes.slice(0,4)}`, 40, 88);

  // tabela: converter para autoTable rows
  const tableBody = rows.map(r=>{
    const ini = parseDateTime(r[0]), fim = parseDateTime(r[1]);
    return [
      ini.toLocaleDateString("pt-BR"),
      `${ini.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})} ‚Üí ${fim.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})}`,
      `${r[0]} at√© ${r[1]}`
    ];
  });

  // usar autoTable
  doc.autoTable({
    startY: 110,
    head: [["Data", "Hor√°rio", "Per√≠odo (valor texto)"]],
    body: tableBody,
    styles: { fontSize:10 },
    headStyles: { fillColor: [41, 128, 185] }
  });

  // assinatura (em branco para voc√™ editar futuramente)
  const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 40 : 300;
  doc.setFontSize(11);
  doc.text("Respons√°vel Administrativo: ____________________________", 40, finalY + 20);
  doc.text("(campo em branco para editar futuramente)", 42, finalY + 36);
  doc.text(`Funcion√°rio (${pessoa.nome}): ____________________________`, 40, finalY + 80);

  // salvar
  const nomeArquivo = `Escala_${pessoa.nome.replace(/\s+/g,'_')}_${mes}.pdf`;
  doc.save(nomeArquivo);
}

/* -------------- MENU UI -------------- */
const hamburgerBtn = document.getElementById("hamburgerBtn");
const menu = document.getElementById("menuPopup");
hamburgerBtn.addEventListener("click", ()=> { menu.style.display = (menu.style.display === "block") ? "none" : "block"; });
window.addEventListener("click", (e)=> { if(!menu.contains(e.target) && e.target !== hamburgerBtn) menu.style.display = "none"; });

/* sincronizar selects do menu com os selects da p√°gina principal */
document.getElementById("funcSelectMenu").addEventListener("change", (e)=>{
  document.getElementById("funcSelect").value = e.target.value; montarLista();
});
document.getElementById("mesSelectMenu").addEventListener("change", (e)=>{
  document.getElementById("mesSelect").value = e.target.value; montarLista();
});

/* bot√µes do menu */
document.getElementById("gerarPdfBtn").addEventListener("click", gerarPDFFuncionarioMes);
document.getElementById("menuLoginBtn").addEventListener("click", openLogin);
document.getElementById("menuLogoutBtn").addEventListener("click", async ()=> {
  await supabaseClient.auth.signOut(); menuUser.textContent = "N√£o conectado"; menuUserEmail.textContent = ""; menuLoginBtn.classList.remove("hidden"); menuLogoutBtn.classList.add("hidden");
});

/* -------------- INICIALIZA√á√ÉO -------------- */
async function initApp(){
  gerarMesesNoSelects();
  popularFuncionariosTo('funcSelect');
  popularFuncionariosTo('funcSelectMenu');
  // tenta carregar do Supabase; se vazio/erro usa gera√ß√£o local
  const ok = await carregarFolgasDoBanco();
  if(!ok){
    gerarFolgasAte2026();
    popularFuncionariosTo('funcSelect');
    popularFuncionariosTo('funcSelectMenu');
    gerarMesesNoSelects();
    montarLista();
  }
  // listeners principais
  document.getElementById("funcSelect").addEventListener("change",(e)=> { document.getElementById("funcSelectMenu").value = e.target.value; montarLista(); });
  document.getElementById("mesSelect").addEventListener("change",(e)=> { document.getElementById("mesSelectMenu").value = e.target.value; montarLista(); });
  // init montagens
  montarLista();
}
initApp();
</script>
</body>
</html>
