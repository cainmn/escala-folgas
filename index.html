<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Escala de Folgas</title>

<style>
    body { font-family: Arial, sans-serif; background:#eef1f5; margin:0; padding:20px; }
    h2 { text-align:center; margin-bottom:12px; }
    .controls { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    select, button { padding:10px; font-size:14px; border-radius:8px; border:1px solid #bbb; cursor:pointer; }
    button.primary { background:#007bff; color:white; border:none; }
    button.green { background:#4caf50; color:white; border:none; }
    button.orange { background:#ff9800; color:white; border:none; }
    button.red { background:#d9534f; color:white; border:none; }
    .pessoa { background:white; padding:14px; margin-bottom:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); transition:0.2s; }
    .em-folga { background:#c4f7c4 !important; border-left:6px solid #2e8b57; }
    .entra-hoje { background:#ffd2d2 !important; border-left:6px solid #c62828; }
    .titulo { font-size:18px; font-weight:700; margin-bottom:8px; }
    .folga-item { padding:6px 0; }
    .data { font-weight:700; color:#222; }
    .hora { color:#444; }
    hr { border:none; border-bottom:1px solid #e6e6e6; margin:8px 0; }
</style>
</head>

<body>

<h2>Escala de Folgas</h2>

<div class="controls">
    <select id="funcSelect"><option value="todos">Todos Funcion√°rios</option></select>

    <select id="mesSelect"></select>

    <button class="primary" onclick="mostrarFolgasAgora()">Quem est√° de folga agora?</button>

    <button class="small" onclick="carregarFolgasDoBanco()">Carregar da Nuvem</button>
    <button class="small" onclick="salvarTodasNoBanco()">Salvar na Nuvem</button>
</div>

<div id="lista"></div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// --------------------------------------------------
// CONFIGURA√á√ÉO SUPABASE (TEXT, SEM UTC!)
// --------------------------------------------------
const SUPABASE_URL = "https://gaqazvekgpvecuhfuiel.supabase.co";
const SUPABASE_KEY = "SUA_ANON_KEY_AQUI";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --------------------------------------------------
// HELPERS DE DATA
// --------------------------------------------------
function pad2(n){ return n.toString().padStart(2,"0"); }

function parseDateTime(str){
    // formato fixo TEXT: "YYYY-MM-DD HH:MM"
    const [d,t] = str.split(" ");
    const [Y,M,D] = d.split("-").map(Number);
    const [h,m] = t.split(":").map(Number);
    return new Date(Y, M-1, D, h, m);
}

function formatDateTime(dt){
    return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}

function formatDateInput(dt){
    return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`;
}
function formatTimeInput(dt){
    return `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}

// --------------------------------------------------
// DADOS INICIAIS (fixos)
// --------------------------------------------------
const folgas = [
    { nome:"Anderson Saraiva Serrano", editando:false, periodos:[
        ["2025-12-02 07:00","2025-12-03 19:00"],
        ["2025-12-10 19:00","2025-12-12 07:00"],
        ["2025-12-19 07:00","2025-12-20 19:00"],
        ["2025-12-27 19:00","2025-12-29 07:00"],
        ["2025-12-30 07:00","2025-12-31 19:00"]
    ]},
    { nome:"Henrique", editando:false, periodos:[
        ["2025-12-03 19:00","2025-12-05 07:00"],
        ["2025-12-12 07:00","2025-12-13 19:00"],
        ["2025-12-20 19:00","2025-12-22 07:00"],
        ["2025-12-23 07:00","2025-12-24 19:00"],
        ["2025-12-31 19:00","2026-01-02 07:00"]
    ]},
    { nome:"Jo√£o", editando:false, periodos:[
        ["2025-12-05 07:00","2025-12-06 19:00"],
        ["2025-12-13 19:00","2025-12-15 07:00"],
        ["2025-12-16 07:00","2025-12-17 19:00"],
        ["2025-12-24 19:00","2025-12-26 07:00"]
    ]},
    { nome:"Rafael", editando:false, periodos:[
        ["2025-12-06 19:00","2025-12-08 07:00"],
        ["2025-12-09 07:00","2025-12-10 19:00"],
        ["2025-12-17 19:00","2025-12-19 07:00"],
        ["2025-12-26 07:00","2025-12-27 19:00"]
    ]},
    { nome:"Vanderlei", editando:false, periodos:[
        ["2025-12-06 19:00","2025-12-08 07:00"],
        ["2025-12-09 07:00","2025-12-10 19:00"],
        ["2025-12-17 19:00","2025-12-19 07:00"],
        ["2025-12-26 07:00","2025-12-27 19:00"]
    ]}
];

// --------------------------------------------------
// GERA TODO O ANO 2026 (mantido como antes)
// --------------------------------------------------
function gerarFolgasAte2026(){
    const limite = new Date(2026,11,31,23,59);

    folgas.forEach(pessoa => {
        let ultFim = parseDateTime(pessoa.periodos[pessoa.periodos.length-1][1]);

        while(true){
            let proxInicio;

            if(ultFim.getDay() === 1){
                proxInicio = new Date(ultFim);
                proxInicio.setDate(proxInicio.getDate()+1);
                proxInicio.setHours(7,0,0,0);
            } else {
                proxInicio = new Date(ultFim.getTime() + 7*24*60*60*1000);

                if(proxInicio.getDay() === 1){
                    proxInicio.setDate(proxInicio.getDate()+1);
                    proxInicio.setHours(7,0,0,0);
                }
            }

            if(proxInicio > limite) break;

            const proxFim = new Date(proxInicio.getTime() + 36*60*60*1000);

            pessoa.periodos.push([
                formatDateTime(proxInicio),
                formatDateTime(proxFim)
            ]);

            ultFim = proxFim;
        }
    });

    // Rafael = Vanderlei
    const r = folgas.find(f=>f.nome==="Rafael");
    const v = folgas.find(f=>f.nome==="Vanderlei");
    if(r && v) v.periodos = JSON.parse(JSON.stringify(r.periodos));
}

// --------------------------------------------------
// POPULAR SELECT DE MESES (ANO 2025/2026 + m√™s atual)
// --------------------------------------------------
function preencherMeses(){
    const sel = document.getElementById("mesSelect");
    sel.innerHTML = `<option value="todos">Todos os meses</option>`;

    const meses = [
        "2025-12",
        "2026-01","2026-02","2026-03","2026-04","2026-05","2026-06",
        "2026-07","2026-08","2026-09","2026-10","2026-11","2026-12"
    ];

    meses.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = formatarMesLabel(m);
        sel.appendChild(opt);
    });

    // Seleciona m√™s atual automaticamente!
    const hoje = new Date();
    const mesAtual = `${hoje.getFullYear()}-${pad2(hoje.getMonth()+1)}`;

    if(meses.includes(mesAtual)){
        sel.value = mesAtual;
    }
}

function formatarMesLabel(m){
    const [ano,mes] = m.split("-");
    const nomes = ["Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    return `${nomes[Number(mes)-1]} ${ano}`;
}

// --------------------------------------------------
// DESTACAR QUEM EST√Å DE FOLGA
// --------------------------------------------------
function estaDeFolga(periodos){
    const agora = new Date();
    return periodos.some(p => {
        const ini = parseDateTime(p[0]);
        const fim = parseDateTime(p[1]);
        return agora >= ini && agora <= fim;
    });
}

// --------------------------------------------------
// MONTAR LISTA
// --------------------------------------------------
function montarLista(){
    const filtroFunc = funcSelect.value;
    const filtroMes = mesSelect.value;

    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    folgas.forEach(pessoa => {

        if(filtroFunc !== "todos" && pessoa.nome !== filtroFunc) return;

        const div = document.createElement("div");
        div.classList.add("pessoa");

        if(estaDeFolga(pessoa.periodos)) div.classList.add("em-folga");

        let periodosFiltrados = pessoa.periodos;

        if(filtroMes !== "todos"){
            periodosFiltrados = pessoa.periodos.filter(p => p[0].slice(0,7) === filtroMes);
            if(periodosFiltrados.length === 0) return;
        }

        div.innerHTML = `
            <div class="titulo">${pessoa.nome}</div>
            ${periodosFiltrados.map((p,i) => `
                <div class="folga-item">
                    <div class="data">üóì ${parseDateTime(p[0]).toLocaleDateString("pt-BR")} ‚Üí ${parseDateTime(p[1]).toLocaleDateString("pt-BR")}</div>
                    <div class="hora">‚è∞ Das ${parseDateTime(p[0]).toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})}
                        √†s ${parseDateTime(p[1]).toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})}</div>
                </div>
                ${i < periodosFiltrados.length-1 ? "<hr>" : ""}
            `).join("")}
        `;

        lista.appendChild(div);
    });
}

// --------------------------------------------------
// SUPABASE ‚Äì CARREGAR
// --------------------------------------------------
async function carregarFolgasDoBanco(){

    const { data, error } = await supabaseClient
        .from("folgas")
        .select("*")
        .order("inicio", { ascending:true });

    if(error){ alert("Erro ao carregar da nuvem."); return; }

    // limpa local
    folgas.forEach(f => f.periodos = []);

    // insere dados da nuvem
    data.forEach(row => {
        const pessoa = folgas.find(f => f.nome === row.funcionario);

        if(pessoa){
            pessoa.periodos.push([row.inicio, row.fim]);
        }
    });

    montarLista();
    alert("Dados carregados!");
}

// --------------------------------------------------
// SUPABASE ‚Äì SALVAR
// --------------------------------------------------
async function salvarTodasNoBanco(){

    await supabaseClient.from("folgas").delete().neq("id", 0);

    const linhas = [];

    folgas.forEach(f => {
        f.periodos.forEach(p => {
            linhas.push({
                funcionario: f.nome,
                inicio: p[0],
                fim: p[1]
            });
        });
    });

    const { error } = await supabaseClient.from("folgas").insert(linhas);

    if(error){ alert("Erro ao salvar!"); return; }

    alert("Salvo na nuvem!");
}

// --------------------------------------------------
// QUEM EST√Å DE FOLGA AGORA
// --------------------------------------------------
function mostrarFolgasAgora(){
    const em = folgas.filter(f => estaDeFolga(f.periodos));
    if(em.length === 0) alert("Ningu√©m est√° de folga agora.");
    else alert("De folga agora:\n\n" + em.map(x=>x.nome).join("\n"));
}

// --------------------------------------------------
// INICIALIZA√á√ÉO
// --------------------------------------------------
gerarFolgasAte2026();
preencherMeses();

folgas.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f.nome;
    opt.textContent = f.nome;
    funcSelect.appendChild(opt);
});

funcSelect.addEventListener("change", montarLista);
mesSelect.addEventListener("change", montarLista);

montarLista();

</script>
</body>
</html>
