<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Escala de Folgas</title>

<style>
    body { font-family: Arial, sans-serif; background:#eef1f5; margin:0; padding:20px; }
    h2 { text-align:center; margin-bottom:12px; }
    .controls { display:flex; justify-content:center; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    select, button { padding:10px; font-size:14px; border-radius:8px; border:1px solid #bbb; cursor:pointer; }
    button.primary { background:#007bff; color:white; border:none; }
    button.green { background:#4caf50; color:white; border:none; }
    button.orange { background:#ff9800; color:white; border:none; }
    button.red { background:#d9534f; color:white; border:none; }
    .pessoa { background:white; padding:14px; margin-bottom:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .em-folga { background:#c4f7c4 !important; border-left:6px solid #2e8b57; }
    .entra-hoje { background:#ffd2d2 !important; border-left:6px solid #c62828; }
    .titulo { font-size:18px; font-weight:700; margin-bottom:8px; }
    .folga-item { padding:6px 0; }
    .data { font-weight:700; color:#222; }
    .hora { color:#444; }
    hr { border:none; border-bottom:1px solid #e6e6e6; margin:8px 0; }
</style>
</head>
<body>

<h2>Escala de Folgas</h2>

<div class="controls">
    <select id="funcSelect"><option value="todos">Todos Funcion√°rios</option></select>

    <select id="mesSelect">
        <option value="todos">Todos os meses</option>
    </select>

    <button class="primary" onclick="mostrarFolgasAgora()">Quem est√° de folga agora?</button>
    <button class="small" onclick="carregarFolgasDoBanco()">Carregar da Nuvem</button>
    <button class="small" onclick="salvarTodasNoBanco()">Salvar na Nuvem</button>
</div>

<div id="lista"></div>

<!-- SUPABASE -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
/* ---------------- CONFIG SUPABASE ---------------- */
const SUPABASE_URL = "https://gaqazvekgpvecuhfuiel.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdhcWF6dmVrZ3B2ZWN1aGZ1aWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MDc1NDQsImV4cCI6MjA4MDQ4MzU0NH0.crmOSloZVI0CMuJkIBLfOI6yKiT8dmEa10xrQnFBIcM";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ---------------- HELPERS ---------------- */
function pad2(n){ return n.toString().padStart(2,"0"); }

function parseDateTime(str){
    const [d,t] = str.split(" ");
    const [Y,M,D] = d.split("-").map(Number);
    const [h,m] = t.split(":").map(Number);
    return new Date(Y, M-1, D, h, m);
}

function formatDateTime(dt){
    return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
}

function formatDateInput(dt){ return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`; }
function formatTimeInput(dt){ return `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`; }

/* ---------------- DADOS INICIAIS (DEZ/2025) ---------------- */
const folgas = [
    { nome:"Anderson Saraiva Serrano", editando:false, periodos:[
        ["2025-12-02 07:00","2025-12-03 19:00"],
        ["2025-12-10 19:00","2025-12-12 07:00"],
        ["2025-12-19 07:00","2025-12-20 19:00"],
        ["2025-12-27 19:00","2025-12-29 07:00"],
        ["2025-12-30 07:00","2025-12-31 19:00"]
    ]},
    { nome:"Henrique", editando:false, periodos:[
        ["2025-12-03 19:00","2025-12-05 07:00"],
        ["2025-12-12 07:00","2025-12-13 19:00"],
        ["2025-12-20 19:00","2025-12-22 07:00"],
        ["2025-12-23 07:00","2025-12-24 19:00"],
        ["2025-12-31 19:00","2026-01-02 07:00"]
    ]},
    { nome:"Jo√£o", editando:false, periodos:[
        ["2025-12-05 07:00","2025-12-06 19:00"],
        ["2025-12-13 19:00","2025-12-15 07:00"],
        ["2025-12-16 07:00","2025-12-17 19:00"],
        ["2025-12-24 19:00","2025-12-26 07:00"]
    ]},
    { nome:"Rafael", editando:false, periodos:[
        ["2025-12-06 19:00","2025-12-08 07:00"],
        ["2025-12-09 07:00","2025-12-10 19:00"],
        ["2025-12-17 19:00","2025-12-19 07:00"],
        ["2025-12-26 07:00","2025-12-27 19:00"]
    ]},
    { nome:"Vanderlei", editando:false, periodos:[] }
];

/* Rafael e Vanderlei iguais */
folgas[4].periodos = JSON.parse(JSON.stringify(folgas[3].periodos));

/* ---------------- GERAR MESES NO SELECT ---------------- */
(function gerarMeses(){
    const sel = document.getElementById("mesSelect");
    const atual = new Date();

    for(let ano=2025; ano<=2026; ano++){
        for(let mes=1; mes<=12; mes++){
            const opt = document.createElement("option");
            opt.value = `${ano}-${pad2(mes)}`;
            const nomeMes = new Date(ano, mes-1, 1).toLocaleDateString("pt-BR",{month:"long"});
            opt.textContent = `${nomeMes} ${ano}`;
            sel.appendChild(opt);
        }
    }

    sel.value = `${atual.getFullYear()}-${pad2(atual.getMonth()+1)}`;
})();

/* ---------------- GERAR FOLGAS AT√â 2026 ---------------- */
function gerarFolgasAte2026(){
    const limite = new Date(2026,11,31,23,59);

    folgas.forEach(pessoa => {
        let ultFim = parseDateTime(pessoa.periodos[pessoa.periodos.length-1][1]);

        while(true){
            let inicio;

            if(ultFim.getDay() === 1){
                inicio = new Date(ultFim);
                inicio.setDate(inicio.getDate()+1);
                inicio.setHours(7,0,0,0);
            } else {
                inicio = new Date(ultFim.getTime() + 7*24*60*60*1000);
                if(inicio.getDay() === 1){
                    inicio.setDate(inicio.getDate()+1);
                    inicio.setHours(7,0,0,0);
                }
            }

            if(inicio > limite) break;

            const fim = new Date(inicio.getTime() + 36*60*60*1000);
            pessoa.periodos.push([formatDateTime(inicio), formatDateTime(fim)]);

            ultFim = fim;
        }
    });

    /* Rafael = Vanderlei */
    folgas[4].periodos = JSON.parse(JSON.stringify(folgas[3].periodos));
}

/* ---------------- MONTAR LISTA ---------------- */
function estaDeFolga(periodos){
    const now = new Date();
    return periodos.some(([i,f]) => now >= parseDateTime(i) && now <= parseDateTime(f));
}

function montarLista(){
    const filtroFunc = funcSelect.value;
    const filtroMes = mesSelect.value;
    const lista = document.getElementById("lista");
    lista.innerHTML = "";

    folgas.forEach(pessoa => {
        if(filtroFunc !== "todos" && pessoa.nome !== filtroFunc) return;

        const nomeID = pessoa.nome.replace(/\s+/g,"_");

        let mostrar = pessoa.periodos;
        if(filtroMes !== "todos"){
            mostrar = mostrar.filter(p => p[0].startsWith(filtroMes));
            if(mostrar.length === 0) return;
        }

        const div = document.createElement("div");
        div.classList.add("pessoa");

        if(estaDeFolga(pessoa.periodos)) div.classList.add("em-folga");

        if(pessoa.editando){
            div.innerHTML = `
                <div class="titulo">${pessoa.nome}</div>

                ${mostrar.map((p,i)=>{
                    const ini = parseDateTime(p[0]), fim = parseDateTime(p[1]);
                    return `
                    <div style="background:#eee;padding:10px;margin-bottom:10px;border-radius:8px;">
                        <b>Per√≠odo ${i+1}</b><br><br>

                        In√≠cio:<br>
                        <input type="date" id="iniData_${nomeID}_${i}" value="${formatDateInput(ini)}"><br>
                        <input type="time" id="iniHora_${nomeID}_${i}" value="${formatTimeInput(ini)}"><br><br>

                        Fim:<br>
                        <input type="date" id="fimData_${nomeID}_${i}" value="${formatDateInput(fim)}"><br>
                        <input type="time" id="fimHora_${nomeID}_${i}" value="${formatTimeInput(fim)}"><br><br>

                        <button class="red" onclick="removerFolga('${pessoa.nome}',${i})">üóë Remover</button>
                    </div>`;
                }).join("")}

                <button class="primary" onclick="adicionarFolga('${pessoa.nome}')">‚ûï Adicionar</button>
                <button class="green" onclick="salvarEdicao('${pessoa.nome}')">Salvar</button>
                <button class="red" onclick="cancelarEdicao('${pessoa.nome}')">Cancelar</button>
            `;
        } 
        else {
            div.innerHTML = `
                <div class="titulo">${pessoa.nome}</div>
                <button class="green" onclick="copiarFolgas('${pessoa.nome}')">üìã Copiar</button>
                <button class="orange" onclick="editar('${pessoa.nome}')">‚úè Editar</button>

                ${mostrar.map((p,i)=>{
                    const ini = parseDateTime(p[0]), fim = parseDateTime(p[1]);
                    return `
                        <div class="folga-item">
                            <div class="data">
                                üóì ${ini.toLocaleDateString("pt-BR")} ‚Üí ${fim.toLocaleDateString("pt-BR")}
                            </div>
                            <div class="hora">
                                ‚è∞ ${ini.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})} ‚Üí 
                                   ${fim.toLocaleTimeString("pt-BR",{hour:'2-digit',minute:'2-digit'})}
                            </div>
                        </div>
                        ${i<mostrar.length-1?'<hr>':''}
                    `;
                }).join("")}
            `;
        }

        lista.appendChild(div);
    });
}

/* ---------------- A√á√ïES ---------------- */
function editar(nome){
    folgas.find(f=>f.nome===nome).editando = true;
    montarLista();
}

function cancelarEdicao(nome){
    folgas.find(f=>f.nome===nome).editando = false;
    montarLista();
}

function removerFolga(nome, idx){
    folgas.find(f=>f.nome===nome).periodos.splice(idx,1);
    montarLista();
}

function adicionarFolga(nome){
    const f = folgas.find(x=>x.nome===nome);
    const lastEnd = parseDateTime(f.periodos[f.periodos.length-1][1]);

    let inicio;

    if(lastEnd.getDay() === 1){
        inicio = new Date(lastEnd);
        inicio.setDate(inicio.getDate()+1);
        inicio.setHours(7,0,0,0);
    } else {
        inicio = new Date(lastEnd.getTime() + 7*24*60*60*1000);
        if(inicio.getDay() === 1){
            inicio.setDate(inicio.getDate()+1);
            inicio.setHours(7,0,0,0);
        }
    }

    const fim = new Date(inicio.getTime() + 36*60*60*1000);

    f.periodos.push([formatDateTime(inicio), formatDateTime(fim)]);
    montarLista();
}

async function salvarEdicao(nome){
    const pessoa = folgas.find(f=>f.nome===nome);
    const nomeID = nome.replace(/\s+/g,"_");

    const filtroMes = mesSelect.value;
    const novos = [];

    pessoa.periodos.forEach((p,i)=>{
        if(!p[0].startsWith(filtroMes)) {
            novos.push(p);
            return;
        }

        const di = document.getElementById(`iniData_${nomeID}_${i}`).value;
        const hi = document.getElementById(`iniHora_${nomeID}_${i}`).value;
        const df = document.getElementById(`fimData_${nomeID}_${i}`).value;
        const hf = document.getElementById(`fimHora_${nomeID}_${i}`).value;

        novos.push([`${di} ${hi}`, `${df} ${hf}`]);
    });

    pessoa.periodos = novos;
    pessoa.editando = false;
    montarLista();

    await salvarTodasNoBanco();
}

/* ---------------- SUPABASE ---------------- */
async function carregarFolgasDoBanco(){
    const {data,error} = await supabaseClient.from("folgas").select("*").order("inicio");

    if(error){ alert("Erro ao carregar."); return; }

    folgas.forEach(f=>f.periodos=[]);

    data.forEach(r=>{
        const f = folgas.find(x=>x.nome===r.funcionario);
        if(f) f.periodos.push([r.inicio, r.fim]);
    });

    montarLista();
    alert("Carregado!");
}

async function salvarTodasNoBanco(){
    await supabaseClient.from("folgas").delete().neq("id",0);

    const linhas = [];
    folgas.forEach(f=>{
        f.periodos.forEach(p=>{
            linhas.push({ funcionario:f.nome, inicio:p[0], fim:p[1] });
        });
    });

    const {error} = await supabaseClient.from("folgas").insert(linhas);
    if(error){ alert("Erro ao salvar."); return; }
    alert("Salvo!");
}

/* ---------------- OUTROS ---------------- */
function mostrarFolgasAgora(){
    const em = folgas.filter(f=>estaDeFolga(f.periodos));
    if(em.length===0) alert("Ningu√©m est√° de folga agora.");
    else alert("Em folga:\n" + em.map(x=>x.nome).join("\n"));
}

function copiarFolgas(nome){
    const f = folgas.find(f=>f.nome===nome);
    const filtroMes = mesSelect.value;

    let lista = f.periodos;
    if(filtroMes !== "todos") lista = lista.filter(p=>p[0].startsWith(filtroMes));

    let txt = `Ol√° ${f.nome}! Aqui est√° sua escala de folgas:\n\n`;
    txt += lista.map(p=>`- ${p[0]} at√© ${p[1]}`).join("\n");

    navigator.clipboard.writeText(txt);
    alert("Copiado!");
}

/* ---------------- INICIAR ---------------- */
gerarFolgasAte2026();
montarLista();
</script>
